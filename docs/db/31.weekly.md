# 주간 리포트 구현 가이드

> inspig 주간 리포트 생성 지침, 절차 및 스케줄 정의

---

## 1. 개요

### 1.1 목적
- 주간/월간 리포트 데이터를 Oracle Scheduler를 통해 자동 생성
- inspig(Next.js)는 생성된 리포트 데이터만 조회하여 표시

### 1.2 아키텍처
```
┌─────────────────────────────────────────────────────────────┐
│                    Oracle Database                          │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────────┐ │
│  │ 원본 테이블  │───▶│ PL/SQL 집계 │───▶│ 리포트 테이블   │ │
│  │ TB_MODON    │    │ 프로시저    │    │ TS_INS_WEEKLY_* │ │
│  │ TB_GYOBAE   │    └─────────────┘    │ TS_INS_MONTHLY_*│ │
│  │ TB_EU 등    │           ▲           └─────────────────┘ │
│  └─────────────┘           │                    │          │
│                    ┌───────┴───────┐            │          │
│                    │ DBMS_SCHEDULER │            │          │
│                    │ (매주 월 03:00)│            │          │
│                    └───────────────┘            │          │
└─────────────────────────────────────────────────┼──────────┘
                                                  │ SELECT
                                                  ▼
                                    ┌─────────────────────────┐
                                    │   inspig (Next.js)      │
                                    │   - 리포트 조회/표시    │
                                    └─────────────────────────┘
```

### 1.3 관련 문서
- [10.table.md](10.table.md) - 테이블 정의 (원본 테이블)
- [11.view.md](11.view.md) - 뷰 정의
- [12.function.md](12.function.md) - 함수/프로시저 정의
- [21.insTable.md](21.insTable.md) - **통계 테이블 DDL (TS_INS_* 테이블)**
- [22.insQuery.md](22.insQuery.md) - 데이터 활용 쿼리
- [23.procedure.md](23.procedure.md) - 프로시저 정의
- [15.ETL.md](15.ETL.md) - ETL 프로세스 (연간 롤링 성적)

---

## 2. 명명 규칙

| 구분 | 접두어 | 예시 |
|------|--------|------|
| 통계 테이블 | `TS_INS_` | TS_INS_WEEKLY_REPORT |
| 스케줄러 Job | `JOB_INS_WEEK_` | JOB_INS_WEEK_REPORT |
| 프로시저 | `SP_INS_` | SP_INS_WEEKLY_REPORT_GEN |
| 함수 | `FN_INS_` | FN_INS_BUILD_WEEKLY_JSON |

---

## 3. Oracle Scheduler Job 설정

### 3.1 주간 리포트 Job (매주 월요일 03:00)

```sql
BEGIN
    -- 기존 Job 삭제 (있는 경우)
    BEGIN
        DBMS_SCHEDULER.DROP_JOB(job_name => 'JOB_INS_WEEK_REPORT');
    EXCEPTION
        WHEN OTHERS THEN NULL;
    END;

    -- Job 생성
    DBMS_SCHEDULER.CREATE_JOB(
        job_name        => 'JOB_INS_WEEK_REPORT',
        job_type        => 'STORED_PROCEDURE',
        job_action      => 'SP_INS_WEEKLY_REPORT_GEN',
        start_date      => TRUNC(NEXT_DAY(SYSDATE - 1, 'MONDAY')) + 3/24,
        repeat_interval => 'FREQ=WEEKLY; BYDAY=MON; BYHOUR=3; BYMINUTE=0; BYSECOND=0',
        enabled         => TRUE,
        auto_drop       => FALSE,
        comments        => '주간 리포트 자동 생성 (매주 월요일 03:00)'
    );
END;
/
```

### 3.2 월간 리포트 Job (매월 1일 04:00)

```sql
BEGIN
    BEGIN
        DBMS_SCHEDULER.DROP_JOB(job_name => 'JOB_INS_WEEK_MONTHLY');
    EXCEPTION
        WHEN OTHERS THEN NULL;
    END;

    DBMS_SCHEDULER.CREATE_JOB(
        job_name        => 'JOB_INS_WEEK_MONTHLY',
        job_type        => 'STORED_PROCEDURE',
        job_action      => 'SP_INS_MONTHLY_REPORT_GEN',
        start_date      => TRUNC(ADD_MONTHS(SYSDATE, 1), 'MM') + 4/24,
        repeat_interval => 'FREQ=MONTHLY; BYMONTHDAY=1; BYHOUR=4; BYMINUTE=0; BYSECOND=0',
        enabled         => TRUE,
        auto_drop       => FALSE,
        comments        => '월간 리포트 자동 생성 (매월 1일 04:00)'
    );
END;
/
```

### 3.3 Job 관리 명령어

```sql
-- Job 상태 확인
SELECT job_name, enabled, state, last_start_date, next_run_date
FROM user_scheduler_jobs
WHERE job_name LIKE 'JOB_INS_WEEK_%';

-- Job 즉시 실행 (테스트용)
EXEC DBMS_SCHEDULER.RUN_JOB('JOB_INS_WEEK_REPORT');

-- Job 비활성화
EXEC DBMS_SCHEDULER.DISABLE('JOB_INS_WEEK_REPORT');

-- Job 활성화
EXEC DBMS_SCHEDULER.ENABLE('JOB_INS_WEEK_REPORT');

-- Job 실행 로그 확인
SELECT log_id, job_name, status, actual_start_date, run_duration
FROM user_scheduler_job_run_details
WHERE job_name = 'JOB_INS_WEEK_REPORT'
ORDER BY log_id DESC;
```

---

## 4. 주간 리포트 생성 절차

### 4.1 생성 흐름

```
1. 스케줄러 트리거 (매주 월요일 03:00)
        │
        ▼
2. SP_INS_WEEKLY_REPORT_GEN 프로시저 실행
        │
        ├─► 대상 주차 계산 (지난주 월~일)
        │
        ├─► 활성 농장 목록 조회 (TA_FARM)
        │
        └─► 농장별 반복 처리
              │
              ├─► 기존 데이터 삭제 (DELETE)
              │
              ├─► 마스터 테이블 INSERT (TS_INS_WEEKLY_REPORT)
              │
              ├─► 상세 테이블 INSERT
              │     ├─► TS_INS_WEEKLY_ALERT (관리대상 모돈)
              │     ├─► TS_INS_WEEKLY_MODON (모돈 현황)
              │     ├─► TS_INS_WEEKLY_MATING (교배 실적)
              │     ├─► TS_INS_WEEKLY_FARROWING (분만 실적)
              │     ├─► TS_INS_WEEKLY_WEANING (이유 실적)
              │     ├─► TS_INS_WEEKLY_ACCIDENT (임신사고)
              │     ├─► TS_INS_WEEKLY_CULLING (도태폐사)
              │     ├─► TS_INS_WEEKLY_SHIPMENT (출하 실적)
              │     └─► TS_INS_WEEKLY_SCHEDULE (작업예정)
              │
              └─► DETAIL_JSON 생성 (FN_INS_BUILD_WEEKLY_JSON)
        │
        ▼
3. COMMIT
```

### 4.2 데이터 수집 대상

| 섹션 | 원본 테이블 | 뷰 | 설명 |
|------|-------------|-----|------|
| 모돈 현황 | TB_MODON, TB_MODON_WK | VM_LAST_MODON_SEQ_WK | 산차별 모돈 구성 |
| 교배 실적 | TB_GYOBAE, TB_MODON_WK | - | 지난주 교배 두수 |
| 분만 실적 | TB_BUNMAN, TB_MODON_WK | - | 지난주 분만 두수, 총산/실산 |
| 이유 실적 | TB_EU, TB_MODON_WK | - | 지난주 이유 두수/자돈수 |
| 임신사고 | TB_SAGO | - | 지난주 사고 두수 |
| 도태폐사 | TB_MODON | - | 지난주 도폐사 두수 |
| 출하 실적 | TM_LPD_DATA | - | 도체중, 등지방, 등급 |
| 작업예정 | TB_PLAN_MODON, TC_FARM_CONFIG | - | 금주 예정 작업 |

---

## 5. inspig에서 조회

### 5.1 API Route 예시 (Next.js)

```typescript
// app/api/report/weekly/[farmNo]/route.ts
import { NextRequest, NextResponse } from 'next/server';
import { query } from '@/lib/oracle';

export async function GET(
    request: NextRequest,
    { params }: { params: { farmNo: string } }
) {
    const { searchParams } = new URL(request.url);
    const weekStart = searchParams.get('weekStart');

    const result = await query(`
        SELECT
            REPORT_SEQ,
            FARM_NO,
            REPORT_WEEK,
            REPORT_YEAR,
            REPORT_WEEK_NO,
            MODON_TOTAL,
            MODON_ACTIVE,
            LAST_GYOBAE_CNT,
            LAST_BUNMAN_CNT,
            LAST_EU_CNT,
            LAST_SAGO_CNT,
            THIS_GYOBAE_CNT,
            THIS_BUNMAN_CNT,
            THIS_EU_CNT,
            DETAIL_JSON
        FROM TS_INS_WEEKLY_REPORT
        WHERE FARM_NO = :farmNo
        AND REPORT_WEEK = TO_DATE(:weekStart, 'YYYY-MM-DD')
    `, { farmNo: params.farmNo, weekStart });

    if (result.rows.length === 0) {
        return NextResponse.json({ error: 'Report not found' }, { status: 404 });
    }

    const row = result.rows[0];
    return NextResponse.json({
        summary: {
            modonTotal: row.MODON_TOTAL,
            modonActive: row.MODON_ACTIVE,
            lastWeek: {
                gyobae: row.LAST_GYOBAE_CNT,
                bunman: row.LAST_BUNMAN_CNT,
                eu: row.LAST_EU_CNT,
                sago: row.LAST_SAGO_CNT
            },
            thisWeek: {
                gyobae: row.THIS_GYOBAE_CNT,
                bunman: row.THIS_BUNMAN_CNT,
                eu: row.THIS_EU_CNT
            }
        },
        detail: JSON.parse(row.DETAIL_JSON)
    });
}
```

### 5.2 상세 데이터 조회 (팝업용)

```typescript
// 관리대상 모돈 상세 조회
const alertData = await query(`
    SELECT PERIOD_CD, HUBO_CNT, EU_MI_CNT, SG_MI_CNT, BM_DELAY_CNT, EU_DELAY_CNT
    FROM TS_INS_WEEKLY_ALERT
    WHERE REPORT_SEQ = :reportSeq
    ORDER BY SORT_NO
`, { reportSeq });

// 모돈 현황 상세 조회
const modonData = await query(`
    SELECT PARITY_CD, GROUP_CD, HUBO_CNT, IMSIN_CNT, POYU_CNT, EUMO_CNT, SAGO_CNT, CHANGE_CNT
    FROM TS_INS_WEEKLY_MODON
    WHERE REPORT_SEQ = :reportSeq
    ORDER BY SORT_NO
`, { reportSeq });

// 출하 실적 상세 조회
const shipmentData = await query(`
    SELECT DATA_TYPE, TOTAL_CNT, GRADE_1_RATE, AVG_CARCASS_KG, AVG_BACKFAT_MM,
           GRADE_CD, GRADE_CNT, SHIP_DATE, SHIP_CNT
    FROM TS_INS_WEEKLY_SHIPMENT
    WHERE REPORT_SEQ = :reportSeq
    ORDER BY DATA_TYPE, SORT_NO
`, { reportSeq });
```

---

## 6. 구현 체크리스트

### 6.1 통계 테이블 생성 (3계층 통합 구조)

> **DDL 상세**: [14.insTable.md](14.insTable.md) 참조

- [ ] TS_INS_MASTER (리포트 생성 마스터)
- [ ] TS_INS_WEEK (농장별 리포트)
- [ ] TS_INS_WEEK_SUB (상세 데이터 - GUBUN으로 구분)
- [ ] SEQ_TS_INS_MASTER (시퀀스)

#### GUBUN 코드 매핑 (TS_INS_WEEK_SUB)
| GUBUN | 용도 | 기존 설계 테이블 |
|-------|------|-----------------|
| ALERT | 관리대상 모돈 | TS_INS_WEEKLY_ALERT |
| MODON | 모돈 현황 | TS_INS_WEEKLY_MODON |
| MATING_T, MATING_C | 교배 실적 | TS_INS_WEEKLY_MATING |
| FARROWING | 분만 실적 | TS_INS_WEEKLY_FARROWING |
| WEANING | 이유 실적 | TS_INS_WEEKLY_WEANING |
| ACCIDENT_T, ACCIDENT_C | 임신사고 | TS_INS_WEEKLY_ACCIDENT |
| CULLING_S, CULLING_T | 도태폐사 | TS_INS_WEEKLY_CULLING |
| SHIP_M, SHIP_G, SHIP_D, SHIP_C | 출하 실적 | TS_INS_WEEKLY_SHIPMENT |
| SCHEDULE, CALENDAR | 금주 작업예정 | TS_INS_WEEKLY_SCHEDULE |
| WEATHER | 주간 날씨 | - |
| PSY_HEAT | PSY 히트맵 | - |
| AUCTION | 경락가격 추이 | - |

### 6.2 PL/SQL 개발
- [ ] FN_INS_BUILD_WEEKLY_JSON 함수 구현
- [ ] SP_INS_WEEKLY_REPORT_GEN 프로시저 구현
- [ ] SP_INS_MONTHLY_REPORT_GEN 프로시저 구현

### 6.3 스케줄러 등록
- [ ] JOB_INS_WEEK_REPORT 스케줄러 등록
- [ ] JOB_INS_WEEK_MONTHLY 스케줄러 등록

### 6.4 inspig 개발
- [ ] API Route 구현
- [ ] 기존 mockData를 실제 API 호출로 교체

---

## 7. 에러 처리

### 7.1 프로시저 내 예외 처리
```sql
EXCEPTION
    WHEN OTHERS THEN
        ROLLBACK;
        -- 에러 로그 테이블에 기록
        INSERT INTO TL_ERROR_LOG (
            ERROR_DATE, ERROR_SOURCE, ERROR_CODE, ERROR_MSG
        ) VALUES (
            SYSDATE, 'SP_INS_WEEKLY_REPORT_GEN', SQLCODE, SQLERRM
        );
        COMMIT;
        RAISE;
```

### 7.2 스케줄러 알림 설정
```sql
-- 실패 시 이메일 알림
BEGIN
    DBMS_SCHEDULER.SET_ATTRIBUTE(
        name      => 'JOB_INS_WEEK_REPORT',
        attribute => 'raise_events',
        value     => DBMS_SCHEDULER.JOB_FAILED
    );
END;
/
```

---

## 8. 참고사항

### 8.1 주차 계산
- ISO 8601 기준: 월요일 시작, 일요일 종료
- Oracle: `TRUNC(date, 'IW')` - 해당 주의 월요일
- 주차 번호: `TO_CHAR(date, 'IW')` - 1~53

### 8.2 해외 농장 지원
- 타임존 변환: `SF_GET_LOCALE_VW_DATE_2022` 함수 사용
- KOR: UTC+9, VNM: UTC+7

### 8.3 데이터 보관 정책
- 주간 리포트: 최근 2년간 보관
- 월간 리포트: 최근 5년간 보관
- 삭제 Job 별도 구현 권장
