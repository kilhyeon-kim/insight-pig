# inspig 통계 테이블 활용 쿼리

> inspig 주간/월간 리포트용 통계 테이블 데이터 생성 및 조회 쿼리

---

## 1. 개요

이 문서는 통계 테이블의 데이터 활용 방법을 설명합니다.

### 1.1 관련 문서
- [21.insTable.md](21.insTable.md) - 테이블 DDL 정의
- [23.procedure.md](23.procedure.md) - 프로시저 정의

---

## 2. GUBUN별 데이터 생성 예시

### 2.1 ALERT (관리대상 모돈)
```sql
-- CODE_1: 기간구분 (~3, 4~7, 8~14, 14~)
-- CNT_1: 후보돈
-- CNT_2: 이유후 미교배
-- CNT_3: 사고후 미교배
-- CNT_4: 교배후 분만지연
-- CNT_5: 분만후 이유지연

INSERT INTO TS_INS_FARM_SUB (MASTER_SEQ, FARM_NO, GUBUN, SORT_NO, CODE_1, CNT_1, CNT_2, CNT_3, CNT_4, CNT_5)
VALUES (100, 1, 'ALERT', 1, '~3', 0, 0, 0, 1, 1);
```

### 2.2 MODON (모돈 현황)
```sql
-- CODE_1: 산차 (후보돈, 0산, 1산...9산↑)
-- CODE_2: 그룹 (hubo, current)
-- CNT_1: 후보두수
-- CNT_2: 임신두수
-- CNT_3: 포유두수
-- CNT_4: 이유모두수
-- CNT_5: 사고두수
-- CNT_6: 증감

INSERT INTO TS_INS_FARM_SUB (MASTER_SEQ, FARM_NO, GUBUN, SORT_NO, CODE_1, CODE_2, CNT_1, CNT_2, CNT_3, CNT_4, CNT_5, CNT_6)
VALUES (100, 1, 'MODON', 1, '후보돈', 'hubo', 250, 0, 0, 0, 0, 5);
```

### 2.3 MATING_T (교배 유형별 테이블)
```sql
-- CODE_1: 유형코드
-- STR_1: 유형명
-- CNT_1: 계획
-- CNT_2: 실적
-- VAL_1: 달성률(%)

INSERT INTO TS_INS_FARM_SUB (MASTER_SEQ, FARM_NO, GUBUN, SORT_NO, CODE_1, STR_1, CNT_1, CNT_2, VAL_1)
VALUES (100, 1, 'MATING_T', 1, 'EU_KS', '이유후(경산)', 36, 34, 94.0);
```

### 2.4 MATING_C (교배 재귀일별 차트)
```sql
-- CODE_1: 재귀일 (7, 10, 15, 20, 25, 30, 35, 40, 45, 50↑)
-- CNT_1: 두수

INSERT INTO TS_INS_FARM_SUB (MASTER_SEQ, FARM_NO, GUBUN, SORT_NO, CODE_1, CNT_1)
VALUES (100, 1, 'MATING_C', 1, '7', 9);
```

### 2.5 FARROWING (분만 성적)
```sql
-- CODE_1: 항목코드 (PLAN, ACTUAL, TOTAL_BORN, BORN_ALIVE, STILLBORN, MUMMY, CULLING, NURSING)
-- STR_1: 항목명
-- CNT_1: 합계
-- VAL_1: 평균
-- VAL_2: 비율(%)

INSERT INTO TS_INS_FARM_SUB (MASTER_SEQ, FARM_NO, GUBUN, SORT_NO, CODE_1, STR_1, CNT_1, VAL_1, VAL_2)
VALUES (100, 1, 'FARROWING', 1, 'TOTAL_BORN', '총산자수', 644, 14.0, NULL);
```

### 2.6 WEANING (이유 성적)
```sql
-- CODE_1: 항목코드 (PLAN, ACTUAL, WEAN_PIGS, PARTIAL, AVG_WEIGHT, SURVIVAL)
-- STR_1: 항목명
-- CNT_1: 합계
-- VAL_1: 평균/비율

INSERT INTO TS_INS_FARM_SUB (MASTER_SEQ, FARM_NO, GUBUN, SORT_NO, CODE_1, STR_1, CNT_1, VAL_1)
VALUES (100, 1, 'WEANING', 1, 'WEAN_PIGS', '이유두수', 552, 12.0);
```

### 2.7 ACCIDENT_T (임신사고 원인별)
```sql
-- CODE_1: 원인코드 (RETURN, EMPTY, ABORT, CULL, DEAD)
-- STR_1: 원인명
-- CNT_1: 금주
-- CNT_2: 누계

INSERT INTO TS_INS_FARM_SUB (MASTER_SEQ, FARM_NO, GUBUN, SORT_NO, CODE_1, STR_1, CNT_1, CNT_2)
VALUES (100, 1, 'ACCIDENT_T', 1, 'RETURN', '재발', 2, 8);
```

### 2.8 ACCIDENT_C (임신사고 임신일별 차트)
```sql
-- CODE_1: 임신일 (~7, 8~10, 11~15, 16~20, 21~35, 36~40, 41~45, 46~)
-- CNT_1: 두수

INSERT INTO TS_INS_FARM_SUB (MASTER_SEQ, FARM_NO, GUBUN, SORT_NO, CODE_1, CNT_1)
VALUES (100, 1, 'ACCIDENT_C', 1, '~7', 1);
```

### 2.9 CULLING_S (도태폐사 유형요약)
```sql
-- CNT_1: 도태
-- CNT_2: 폐사
-- CNT_3: 전출
-- CNT_4: 매각

INSERT INTO TS_INS_FARM_SUB (MASTER_SEQ, FARM_NO, GUBUN, SORT_NO, CNT_1, CNT_2, CNT_3, CNT_4)
VALUES (100, 1, 'CULLING_S', 1, 4, 2, 1, 1);
```

### 2.10 CULLING_T (도태폐사 원인별)
```sql
-- CODE_1: 원인코드
-- STR_1: 원인명
-- CNT_1: 금주
-- CNT_2: 누계

INSERT INTO TS_INS_FARM_SUB (MASTER_SEQ, FARM_NO, GUBUN, SORT_NO, CODE_1, STR_1, CNT_1, CNT_2)
VALUES (100, 1, 'CULLING_T', 1, 'REPRO', '번식장애', 2, 8);
```

### 2.11 SHIP_M (출하 현황요약)
```sql
-- CNT_1: 총출하두수
-- CNT_2: 1+등급 두수
-- CNT_3: 1등급 두수
-- CNT_4: 2등급 두수
-- CNT_5: 등외 두수
-- VAL_1: 1등급비율(%)
-- VAL_2: 평균도체중(kg)
-- VAL_3: 평균등지방(mm)
-- VAL_4: 농장가격(원)
-- STR_1: 전주대비 (+20, -10 등)

INSERT INTO TS_INS_FARM_SUB (MASTER_SEQ, FARM_NO, GUBUN, SORT_NO, CNT_1, CNT_2, CNT_3, CNT_4, CNT_5, VAL_1, VAL_2, VAL_3, VAL_4, STR_1)
VALUES (100, 1, 'SHIP_M', 1, 500, 165, 240, 70, 25, 84.6, 86.0, 21.5, 5220, '+20');
```

### 2.12 SHIP_G (출하 등급분포)
```sql
-- CODE_1: 등급코드 (1+, 1, 2, 등외)
-- CNT_1: 두수
-- STR_1: 색상
-- STR_2: 색상끝 (그라데이션용)

INSERT INTO TS_INS_FARM_SUB (MASTER_SEQ, FARM_NO, GUBUN, SORT_NO, CODE_1, CNT_1, STR_1, STR_2)
VALUES (100, 1, 'SHIP_G', 1, '1+', 165, '#667eea', '#764ba2');
```

### 2.13 SHIP_D (출하 일별상세)
```sql
-- STR_1: 일자 (MM.DD)
-- WK_DATE: 출하일
-- CNT_1: 두수
-- VAL_1: 평균도체중
-- VAL_2: 평균등지방
-- VAL_3: 1등급비율

INSERT INTO TS_INS_FARM_SUB (MASTER_SEQ, FARM_NO, GUBUN, SORT_NO, STR_1, WK_DATE, CNT_1, VAL_1, VAL_2, VAL_3)
VALUES (100, 1, 'SHIP_D', 1, '11.18', TO_DATE('20241118','YYYYMMDD'), 68, 85.5, 21.2, 78.9);
```

### 2.14 SHIP_C (출하 도체분포차트)
```sql
-- VAL_1: 도체중(kg)
-- VAL_2: 등지방(mm)
-- CNT_1: 두수

INSERT INTO TS_INS_FARM_SUB (MASTER_SEQ, FARM_NO, GUBUN, SORT_NO, VAL_1, VAL_2, CNT_1)
VALUES (100, 1, 'SHIP_C', 1, 88.0, 21.0, 45);
```

### 2.15 SCHEDULE (작업예정)
```sql
-- CODE_1: 유형 (scheduleGb, scheduleBm, scheduleEu, scheduleVaccine)
-- STR_1: 작업명 (교배, 분만, 이유, 파보, PED 등)
-- STR_2: 기준작업|대상그룹|경과일수 (파이프로 구분)
-- CNT_1: 두수

INSERT INTO TS_INS_FARM_SUB (MASTER_SEQ, FARM_NO, GUBUN, SORT_NO, CODE_1, STR_1, STR_2, CNT_1)
VALUES (100, 1, 'SCHEDULE', 1, 'scheduleGb', '교배', '이유|경산돈|5~7일', 34);
```

### 2.16 CALENDAR (캘린더 일별)
```sql
-- CODE_1: 작업유형 (gb, bm, eu, vaccine, imsin3w, imsin4w)
-- WK_DATE: 예정일
-- CNT_1: 두수

INSERT INTO TS_INS_FARM_SUB (MASTER_SEQ, FARM_NO, GUBUN, SORT_NO, CODE_1, WK_DATE, CNT_1)
VALUES (100, 1, 'CALENDAR', 1, 'gb', TO_DATE('20241125','YYYYMMDD'), 30);
```

---

## 3. 관리포인트 데이터 생성

### 3.1 데이터 예시
```sql
-- 주요 관리포인트 (HIGHLIGHT)
INSERT INTO TS_INS_MGMT (MASTER_SEQ, MGMT_TYPE, SORT_NO, CONTENT, LINK_URL)
VALUES (100, 'HIGHLIGHT', 1, '겨울철 돈사 온도관리 (자돈사 28~30℃)', NULL);

INSERT INTO TS_INS_MGMT (MASTER_SEQ, MGMT_TYPE, SORT_NO, CONTENT, LINK_URL)
VALUES (100, 'HIGHLIGHT', 2, 'PED 예방 차단방역 강화', NULL);

-- 추천 콘텐츠 (RECOMMEND)
INSERT INTO TS_INS_MGMT (MASTER_SEQ, MGMT_TYPE, SORT_NO, CONTENT, LINK_URL)
VALUES (100, 'RECOMMEND', 1, '겨울철 돈사 환경 관리 매뉴얼', 'https://example.com/manual1');

INSERT INTO TS_INS_MGMT (MASTER_SEQ, MGMT_TYPE, SORT_NO, CONTENT, LINK_URL)
VALUES (100, 'RECOMMEND', 2, 'PED 예방 및 대응 가이드', 'https://example.com/ped-guide');
```

---

## 4. 조회 쿼리

### 4.1 마스터 테이블 조회 (TS_INS_MASTER)

```sql
-- 최근 주간 리포트 생성 현황 조회
SELECT SEQ, DAY_GB, REPORT_YEAR, REPORT_WEEK_NO, DT_FROM, DT_TO,
       TARGET_CNT, COMPLETE_CNT, ERROR_CNT, STATUS_CD
FROM TS_INS_MASTER
WHERE DAY_GB = 'WEEK'
ORDER BY SEQ DESC
FETCH FIRST 10 ROWS ONLY;

-- 특정 주차의 마스터 조회
SELECT *
FROM TS_INS_MASTER
WHERE DAY_GB = 'WEEK'
AND REPORT_YEAR = :year
AND REPORT_WEEK_NO = :weekNo;

-- 리포트 생성 완료 목록 조회
SELECT SEQ, DAY_GB, REPORT_YEAR, REPORT_WEEK_NO, DT_FROM, DT_TO,
       TARGET_CNT, COMPLETE_CNT, ERROR_CNT
FROM TS_INS_MASTER
WHERE STATUS_CD = 'COMPLETE'
ORDER BY SEQ DESC;
```

### 4.2 농장별 데이터 조회 (TS_INS_FARM)

```sql
-- 특정 농장의 최근 주간 리포트 조회
SELECT f.*
FROM TS_INS_FARM f
JOIN TS_INS_MASTER m ON f.MASTER_SEQ = m.SEQ
WHERE f.FARM_NO = :farmNo
AND m.DAY_GB = 'WEEK'
ORDER BY m.SEQ DESC
FETCH FIRST 1 ROW ONLY;

-- 특정 기간의 리포트 목록 조회
SELECT m.SEQ AS MASTER_SEQ, f.FARM_NO, m.DT_FROM, m.DT_TO, f.FARM_NM
FROM TS_INS_FARM f
JOIN TS_INS_MASTER m ON f.MASTER_SEQ = m.SEQ
WHERE f.FARM_NO = :farmNo
AND m.DAY_GB = 'WEEK'
AND m.DT_FROM BETWEEN :fromDt AND :toDt
ORDER BY m.SEQ DESC;
```

### 4.3 상세 데이터 조회 (팝업용)

```sql
-- 관리대상 모돈 팝업 데이터
SELECT CODE_1 AS PERIOD, CNT_1 AS HUBO, CNT_2 AS EU_MI, CNT_3 AS SG_MI, CNT_4 AS BM_DELAY, CNT_5 AS EU_DELAY
FROM TS_INS_FARM_SUB
WHERE MASTER_SEQ = :masterSeq AND FARM_NO = :farmNo AND GUBUN = 'ALERT'
ORDER BY SORT_NO;

-- 모돈 현황 팝업 데이터
SELECT CODE_1 AS PARITY, CODE_2 AS GROUP_CD,
       CNT_1 AS HUBO, CNT_2 AS IMSIN, CNT_3 AS POYU, CNT_4 AS EUMO, CNT_5 AS SAGO, CNT_6 AS CHANGE_CNT
FROM TS_INS_FARM_SUB
WHERE MASTER_SEQ = :masterSeq AND FARM_NO = :farmNo AND GUBUN = 'MODON'
ORDER BY SORT_NO;

-- 교배 유형별 테이블 + 재귀일 차트 동시 조회
SELECT GUBUN, CODE_1, STR_1, CNT_1, CNT_2, VAL_1
FROM TS_INS_FARM_SUB
WHERE MASTER_SEQ = :masterSeq AND FARM_NO = :farmNo AND GUBUN IN ('MATING_T', 'MATING_C')
ORDER BY GUBUN, SORT_NO;

-- 출하 전체 데이터 (요약 + 등급 + 일별 + 차트)
SELECT GUBUN, CODE_1, STR_1, STR_2, CNT_1, CNT_2, CNT_3, CNT_4, CNT_5, VAL_1, VAL_2, VAL_3, VAL_4, WK_DATE
FROM TS_INS_FARM_SUB
WHERE MASTER_SEQ = :masterSeq AND FARM_NO = :farmNo AND GUBUN LIKE 'SHIP%'
ORDER BY GUBUN, SORT_NO;

-- 작업예정 + 캘린더 조회
SELECT GUBUN, CODE_1, STR_1, STR_2, CNT_1, WK_DATE
FROM TS_INS_FARM_SUB
WHERE MASTER_SEQ = :masterSeq AND FARM_NO = :farmNo AND GUBUN IN ('SCHEDULE', 'CALENDAR')
ORDER BY GUBUN, SORT_NO;
```

### 4.4 PSY 히트맵 조회

```sql
-- 특정 주차의 PSY 히트맵 조회
SELECT X_POS, Y_POS, ZONE_CD, FARM_CNT
FROM TS_INS_PSY_HEATMAP
WHERE MASTER_SEQ = :masterSeq
ORDER BY Y_POS DESC, X_POS;

-- 특정 농장의 위치 조회 (TS_INS_FARM에서)
SELECT FARM_NO, FARM_NM, PSY_X, PSY_Y, PSY_ZONE
FROM TS_INS_FARM
WHERE MASTER_SEQ = :masterSeq
AND FARM_NO = :farmNo;
```

### 4.5 날씨 조회

```sql
-- 특정 시군구의 주간 날씨 조회
SELECT WK_DATE, WEATHER_CD, TEMP_HIGH, TEMP_LOW, RAIN_PROB, HUMIDITY
FROM TS_INS_WEATHER
WHERE SIGUNGU_CD = :sigunguCd
AND WK_DATE BETWEEN :fromDt AND :toDt
ORDER BY WK_DATE;

-- 특정 격자 좌표의 날씨 조회
SELECT WK_DATE, WEATHER_CD, TEMP_HIGH, TEMP_LOW, RAIN_PROB
FROM TS_INS_WEATHER
WHERE NX = :nx AND NY = :ny
AND WK_DATE = :wkDate;

-- 농장 위치 기반 날씨 조회 (TS_INS_FARM과 조인)
SELECT w.WK_DATE, w.WEATHER_CD, w.TEMP_HIGH, w.TEMP_LOW, w.RAIN_PROB, w.SIGUNGU_NM
FROM TS_INS_WEATHER w
JOIN TS_INS_FARM f ON f.SIGUNGU_CD = w.SIGUNGU_CD
WHERE f.MASTER_SEQ = :masterSeq AND f.FARM_NO = :farmNo
AND w.WK_DATE BETWEEN :fromDt AND :toDt
ORDER BY w.WK_DATE;
```

### 4.6 관리포인트 조회

```sql
-- 특정 주차의 관리포인트 조회
SELECT MGMT_TYPE, SORT_NO, CONTENT, LINK_URL
FROM TS_INS_MGMT
WHERE MASTER_SEQ = :masterSeq
ORDER BY MGMT_TYPE, SORT_NO;

-- 하이라이트만 조회
SELECT SORT_NO, CONTENT
FROM TS_INS_MGMT
WHERE MASTER_SEQ = :masterSeq AND MGMT_TYPE = 'HIGHLIGHT'
ORDER BY SORT_NO;

-- 추천 콘텐츠만 조회 (링크 포함)
SELECT SORT_NO, CONTENT, LINK_URL
FROM TS_INS_MGMT
WHERE MASTER_SEQ = :masterSeq AND MGMT_TYPE = 'RECOMMEND'
ORDER BY SORT_NO;
```

---

## 5. 데이터 정리 쿼리

### 5.1 마스터 삭제 (CASCADE)
```sql
-- 마스터 삭제 시 하위 데이터 자동 삭제
DELETE FROM TS_INS_MASTER WHERE SEQ = :masterSeq;
```

### 5.2 기간별 데이터 정리
```sql
-- 2년 이상 된 주간 리포트 삭제
DELETE FROM TS_INS_MASTER
WHERE DAY_GB = 'WEEK'
AND DT_TO < ADD_MONTHS(SYSDATE, -24);

-- 5년 이상 된 월간 리포트 삭제
DELETE FROM TS_INS_MASTER
WHERE DAY_GB = 'MON'
AND DT_TO < ADD_MONTHS(SYSDATE, -60);
```

### 5.3 날씨 데이터 정리
```sql
-- 1년 이상 된 날씨 데이터 삭제
DELETE FROM TS_INS_WEATHER
WHERE WK_DATE < ADD_MONTHS(SYSDATE, -12);
```
