# inspig 통계 테이블 활용 쿼리

> inspig 주간/월간 리포트용 통계 테이블 데이터 생성 및 조회 쿼리

---

## 1. 개요

이 문서는 통계 테이블의 데이터 활용 방법을 설명합니다.

### 1.1 관련 문서
- [21.insTable.md](21.insTable.md) - 테이블 DDL 정의
- [23.procedure.md](23.procedure.md) - 프로시저 정의

---

## 2. GUBUN별 데이터 생성 예시

### 2.1 ALERT (관리대상 모돈)
```sql
-- CODE_1: 기간구분 (~3, 4~7, 8~14, 14~)
-- CNT_1: 후보돈
-- CNT_2: 이유후 미교배
-- CNT_3: 사고후 미교배
-- CNT_4: 교배후 분만지연
-- CNT_5: 분만후 이유지연

INSERT INTO TS_INS_WEEK_SUB (MASTER_SEQ, FARM_NO, GUBUN, SORT_NO, CODE_1, CNT_1, CNT_2, CNT_3, CNT_4, CNT_5)
VALUES (100, 1, 'ALERT', 1, '~3', 0, 0, 0, 1, 1);
```

### 2.2 MODON (모돈 현황)
```sql
-- CODE_1: 산차 (후보돈, 0산, 1산...9산↑)
-- CODE_2: 그룹 (hubo, current)
-- CNT_1: 후보두수
-- CNT_2: 임신두수
-- CNT_3: 포유두수
-- CNT_4: 이유모두수
-- CNT_5: 사고두수
-- CNT_6: 증감

INSERT INTO TS_INS_WEEK_SUB (MASTER_SEQ, FARM_NO, GUBUN, SORT_NO, CODE_1, CODE_2, CNT_1, CNT_2, CNT_3, CNT_4, CNT_5, CNT_6)
VALUES (100, 1, 'MODON', 1, '후보돈', 'hubo', 250, 0, 0, 0, 0, 5);
```

### 2.3 MATING_T (교배 유형별 테이블)
```sql
-- CODE_1: 유형코드
-- STR_1: 유형명
-- CNT_1: 계획
-- CNT_2: 실적
-- VAL_1: 달성률(%)

INSERT INTO TS_INS_WEEK_SUB (MASTER_SEQ, FARM_NO, GUBUN, SORT_NO, CODE_1, STR_1, CNT_1, CNT_2, VAL_1)
VALUES (100, 1, 'MATING_T', 1, 'EU_KS', '이유후(경산)', 36, 34, 94.0);
```

### 2.4 MATING_C (교배 재귀일별 차트)
```sql
-- CODE_1: 재귀일 (7, 10, 15, 20, 25, 30, 35, 40, 45, 50↑)
-- CNT_1: 두수

INSERT INTO TS_INS_WEEK_SUB (MASTER_SEQ, FARM_NO, GUBUN, SORT_NO, CODE_1, CNT_1)
VALUES (100, 1, 'MATING_C', 1, '7', 9);
```

### 2.5 FARROWING (분만 성적)
```sql
-- CODE_1: 항목코드 (PLAN, ACTUAL, TOTAL_BORN, BORN_ALIVE, STILLBORN, MUMMY, CULLING, NURSING)
-- STR_1: 항목명
-- CNT_1: 합계
-- VAL_1: 평균
-- VAL_2: 비율(%)

INSERT INTO TS_INS_WEEK_SUB (MASTER_SEQ, FARM_NO, GUBUN, SORT_NO, CODE_1, STR_1, CNT_1, VAL_1, VAL_2)
VALUES (100, 1, 'FARROWING', 1, 'TOTAL_BORN', '총산자수', 644, 14.0, NULL);
```

### 2.6 WEANING (이유 성적)
```sql
-- CODE_1: 항목코드 (PLAN, ACTUAL, WEAN_PIGS, PARTIAL, AVG_WEIGHT, SURVIVAL)
-- STR_1: 항목명
-- CNT_1: 합계
-- VAL_1: 평균/비율

INSERT INTO TS_INS_WEEK_SUB (MASTER_SEQ, FARM_NO, GUBUN, SORT_NO, CODE_1, STR_1, CNT_1, VAL_1)
VALUES (100, 1, 'WEANING', 1, 'WEAN_PIGS', '이유두수', 552, 12.0);
```

### 2.7 ACCIDENT_T (임신사고 원인별)
```sql
-- CODE_1: 원인코드 (RETURN, EMPTY, ABORT, CULL, DEAD)
-- STR_1: 원인명
-- CNT_1: 금주
-- CNT_2: 누계

INSERT INTO TS_INS_WEEK_SUB (MASTER_SEQ, FARM_NO, GUBUN, SORT_NO, CODE_1, STR_1, CNT_1, CNT_2)
VALUES (100, 1, 'ACCIDENT_T', 1, 'RETURN', '재발', 2, 8);
```

### 2.8 ACCIDENT_C (임신사고 임신일별 차트)
```sql
-- CODE_1: 임신일 (~7, 8~10, 11~15, 16~20, 21~35, 36~40, 41~45, 46~)
-- CNT_1: 두수

INSERT INTO TS_INS_WEEK_SUB (MASTER_SEQ, FARM_NO, GUBUN, SORT_NO, CODE_1, CNT_1)
VALUES (100, 1, 'ACCIDENT_C', 1, '~7', 1);
```

### 2.9 CULLING_S (도태폐사 유형요약)
```sql
-- CNT_1: 도태
-- CNT_2: 폐사
-- CNT_3: 전출
-- CNT_4: 매각

INSERT INTO TS_INS_WEEK_SUB (MASTER_SEQ, FARM_NO, GUBUN, SORT_NO, CNT_1, CNT_2, CNT_3, CNT_4)
VALUES (100, 1, 'CULLING_S', 1, 4, 2, 1, 1);
```

### 2.10 CULLING_T (도태폐사 원인별)
```sql
-- CODE_1: 원인코드
-- STR_1: 원인명
-- CNT_1: 금주
-- CNT_2: 누계

INSERT INTO TS_INS_WEEK_SUB (MASTER_SEQ, FARM_NO, GUBUN, SORT_NO, CODE_1, STR_1, CNT_1, CNT_2)
VALUES (100, 1, 'CULLING_T', 1, 'REPRO', '번식장애', 2, 8);
```

### 2.11 SHIP_M (출하 현황요약)
```sql
-- CNT_1: 총출하두수
-- CNT_2: 1+등급 두수
-- CNT_3: 1등급 두수
-- CNT_4: 2등급 두수
-- CNT_5: 등외 두수
-- VAL_1: 1등급비율(%)
-- VAL_2: 평균도체중(kg)
-- VAL_3: 평균등지방(mm)
-- VAL_4: 농장가격(원)
-- STR_1: 전주대비 (+20, -10 등)

INSERT INTO TS_INS_WEEK_SUB (MASTER_SEQ, FARM_NO, GUBUN, SORT_NO, CNT_1, CNT_2, CNT_3, CNT_4, CNT_5, VAL_1, VAL_2, VAL_3, VAL_4, STR_1)
VALUES (100, 1, 'SHIP_M', 1, 500, 165, 240, 70, 25, 84.6, 86.0, 21.5, 5220, '+20');
```

### 2.12 SHIP_G (출하 등급분포)
```sql
-- CODE_1: 등급코드 (1+, 1, 2, 등외)
-- CNT_1: 두수
-- STR_1: 색상
-- STR_2: 색상끝 (그라데이션용)

INSERT INTO TS_INS_WEEK_SUB (MASTER_SEQ, FARM_NO, GUBUN, SORT_NO, CODE_1, CNT_1, STR_1, STR_2)
VALUES (100, 1, 'SHIP_G', 1, '1+', 165, '#667eea', '#764ba2');
```

### 2.13 SHIP_D (출하 일별상세)
```sql
-- STR_1: 일자 (MM.DD)
-- WK_DATE: 출하일
-- CNT_1: 두수
-- VAL_1: 평균도체중
-- VAL_2: 평균등지방
-- VAL_3: 1등급비율

INSERT INTO TS_INS_WEEK_SUB (MASTER_SEQ, FARM_NO, GUBUN, SORT_NO, STR_1, WK_DATE, CNT_1, VAL_1, VAL_2, VAL_3)
VALUES (100, 1, 'SHIP_D', 1, '11.18', TO_DATE('20241118','YYYYMMDD'), 68, 85.5, 21.2, 78.9);
```

### 2.14 SHIP_C (출하 도체분포차트)
```sql
-- VAL_1: 도체중(kg)
-- VAL_2: 등지방(mm)
-- CNT_1: 두수

INSERT INTO TS_INS_WEEK_SUB (MASTER_SEQ, FARM_NO, GUBUN, SORT_NO, VAL_1, VAL_2, CNT_1)
VALUES (100, 1, 'SHIP_C', 1, 88.0, 21.0, 45);
```

### 2.15 SCHEDULE (작업예정)
```sql
-- CODE_1: 유형 (scheduleGb, scheduleBm, scheduleEu, scheduleVaccine)
-- STR_1: 작업명 (교배, 분만, 이유, 파보, PED 등)
-- STR_2: 기준작업|대상그룹|경과일수 (파이프로 구분)
-- CNT_1: 두수

INSERT INTO TS_INS_WEEK_SUB (MASTER_SEQ, FARM_NO, GUBUN, SORT_NO, CODE_1, STR_1, STR_2, CNT_1)
VALUES (100, 1, 'SCHEDULE', 1, 'scheduleGb', '교배', '이유|경산돈|5~7일', 34);
```

### 2.16 CALENDAR (캘린더 일별)
```sql
-- CODE_1: 작업유형 (gb, bm, eu, vaccine, imsin3w, imsin4w)
-- WK_DATE: 예정일
-- CNT_1: 두수

INSERT INTO TS_INS_WEEK_SUB (MASTER_SEQ, FARM_NO, GUBUN, SORT_NO, CODE_1, WK_DATE, CNT_1)
VALUES (100, 1, 'CALENDAR', 1, 'gb', TO_DATE('20241125','YYYYMMDD'), 30);
```

---

## 3. 관리포인트 데이터 생성

### 3.1 데이터 예시
```sql
-- 주요 관리포인트 (HIGHLIGHT)
INSERT INTO TS_INS_MGMT (MASTER_SEQ, MGMT_TYPE, SORT_NO, CONTENT, LINK_URL)
VALUES (100, 'HIGHLIGHT', 1, '겨울철 돈사 온도관리 (자돈사 28~30℃)', NULL);

INSERT INTO TS_INS_MGMT (MASTER_SEQ, MGMT_TYPE, SORT_NO, CONTENT, LINK_URL)
VALUES (100, 'HIGHLIGHT', 2, 'PED 예방 차단방역 강화', NULL);

-- 추천 콘텐츠 (RECOMMEND)
INSERT INTO TS_INS_MGMT (MASTER_SEQ, MGMT_TYPE, SORT_NO, CONTENT, LINK_URL)
VALUES (100, 'RECOMMEND', 1, '겨울철 돈사 환경 관리 매뉴얼', 'https://example.com/manual1');

INSERT INTO TS_INS_MGMT (MASTER_SEQ, MGMT_TYPE, SORT_NO, CONTENT, LINK_URL)
VALUES (100, 'RECOMMEND', 2, 'PED 예방 및 대응 가이드', 'https://example.com/ped-guide');
```

---

## 4. 조회 쿼리

### 4.1 마스터 테이블 조회 (TS_INS_MASTER)

```sql
-- 최근 주간 리포트 생성 현황 조회
SELECT SEQ, DAY_GB, REPORT_YEAR, REPORT_WEEK_NO, DT_FROM, DT_TO,
       TARGET_CNT, COMPLETE_CNT, ERROR_CNT, STATUS_CD
FROM TS_INS_MASTER
WHERE DAY_GB = 'WEEK'
ORDER BY SEQ DESC
FETCH FIRST 10 ROWS ONLY;

-- 특정 주차의 마스터 조회
SELECT *
FROM TS_INS_MASTER
WHERE DAY_GB = 'WEEK'
AND REPORT_YEAR = :year
AND REPORT_WEEK_NO = :weekNo;

-- 리포트 생성 완료 목록 조회
SELECT SEQ, DAY_GB, REPORT_YEAR, REPORT_WEEK_NO, DT_FROM, DT_TO,
       TARGET_CNT, COMPLETE_CNT, ERROR_CNT
FROM TS_INS_MASTER
WHERE STATUS_CD = 'COMPLETE'
ORDER BY SEQ DESC;
```

### 4.2 주간 리포트 데이터 조회 (TS_INS_WEEK)

```sql
-- 특정 농장의 최근 주간 리포트 조회
SELECT w.*
FROM TS_INS_WEEK w
JOIN TS_INS_MASTER m ON w.MASTER_SEQ = m.SEQ
WHERE w.FARM_NO = :farmNo
AND m.DAY_GB = 'WEEK'
ORDER BY m.SEQ DESC
FETCH FIRST 1 ROW ONLY;

-- 특정 기간의 리포트 목록 조회
SELECT m.SEQ AS MASTER_SEQ, w.FARM_NO, m.DT_FROM, m.DT_TO, w.FARM_NM
FROM TS_INS_WEEK w
JOIN TS_INS_MASTER m ON w.MASTER_SEQ = m.SEQ
WHERE w.FARM_NO = :farmNo
AND m.DAY_GB = 'WEEK'
AND m.DT_FROM BETWEEN :fromDt AND :toDt
ORDER BY m.SEQ DESC;
```

### 4.3 상세 데이터 조회 (팝업용)

```sql
-- 관리대상 모돈 팝업 데이터
SELECT CODE_1 AS PERIOD, CNT_1 AS HUBO, CNT_2 AS EU_MI, CNT_3 AS SG_MI, CNT_4 AS BM_DELAY, CNT_5 AS EU_DELAY
FROM TS_INS_WEEK_SUB
WHERE MASTER_SEQ = :masterSeq AND FARM_NO = :farmNo AND GUBUN = 'ALERT'
ORDER BY SORT_NO;

-- 모돈 현황 팝업 데이터
SELECT CODE_1 AS PARITY, CODE_2 AS GROUP_CD,
       CNT_1 AS HUBO, CNT_2 AS IMSIN, CNT_3 AS POYU, CNT_4 AS EUMO, CNT_5 AS SAGO, CNT_6 AS CHANGE_CNT
FROM TS_INS_WEEK_SUB
WHERE MASTER_SEQ = :masterSeq AND FARM_NO = :farmNo AND GUBUN = 'MODON'
ORDER BY SORT_NO;

-- 교배 유형별 테이블 + 재귀일 차트 동시 조회
SELECT GUBUN, CODE_1, STR_1, CNT_1, CNT_2, VAL_1
FROM TS_INS_WEEK_SUB
WHERE MASTER_SEQ = :masterSeq AND FARM_NO = :farmNo AND GUBUN IN ('MATING_T', 'MATING_C')
ORDER BY GUBUN, SORT_NO;

-- 출하 전체 데이터 (요약 + 등급 + 일별 + 차트)
SELECT GUBUN, CODE_1, STR_1, STR_2, CNT_1, CNT_2, CNT_3, CNT_4, CNT_5, VAL_1, VAL_2, VAL_3, VAL_4, WK_DATE
FROM TS_INS_WEEK_SUB
WHERE MASTER_SEQ = :masterSeq AND FARM_NO = :farmNo AND GUBUN LIKE 'SHIP%'
ORDER BY GUBUN, SORT_NO;

-- 작업예정 + 캘린더 조회
SELECT GUBUN, CODE_1, STR_1, STR_2, CNT_1, WK_DATE
FROM TS_INS_WEEK_SUB
WHERE MASTER_SEQ = :masterSeq AND FARM_NO = :farmNo AND GUBUN IN ('SCHEDULE', 'CALENDAR')
ORDER BY GUBUN, SORT_NO;
```

### 4.4 PSY 히트맵 조회

```sql
-- 특정 주차의 PSY 히트맵 조회
SELECT X_POS, Y_POS, ZONE_CD, FARM_CNT
FROM TS_INS_PSY_HEATMAP
WHERE MASTER_SEQ = :masterSeq
ORDER BY Y_POS DESC, X_POS;

-- 특정 농장의 위치 조회 (TS_INS_WEEK에서)
SELECT FARM_NO, FARM_NM, PSY_X, PSY_Y, PSY_ZONE
FROM TS_INS_WEEK
WHERE MASTER_SEQ = :masterSeq
AND FARM_NO = :farmNo;
```

### 4.5 날씨 조회

```sql
-- 특정 시군구의 주간 날씨 조회
SELECT WK_DATE, WEATHER_CD, TEMP_HIGH, TEMP_LOW, RAIN_PROB, HUMIDITY
FROM TS_INS_WEATHER
WHERE SIGUNGU_CD = :sigunguCd
AND WK_DATE BETWEEN :fromDt AND :toDt
ORDER BY WK_DATE;

-- 특정 격자 좌표의 날씨 조회
SELECT WK_DATE, WEATHER_CD, TEMP_HIGH, TEMP_LOW, RAIN_PROB
FROM TS_INS_WEATHER
WHERE NX = :nx AND NY = :ny
AND WK_DATE = :wkDate;

-- 농장 위치 기반 날씨 조회 (TS_INS_WEEK과 조인)
SELECT wt.WK_DATE, wt.WEATHER_CD, wt.TEMP_HIGH, wt.TEMP_LOW, wt.RAIN_PROB, wt.SIGUNGU_NM
FROM TS_INS_WEATHER wt
JOIN TS_INS_WEEK w ON w.SIGUNGU_CD = wt.SIGUNGU_CD
WHERE w.MASTER_SEQ = :masterSeq AND w.FARM_NO = :farmNo
AND wt.WK_DATE BETWEEN :fromDt AND :toDt
ORDER BY wt.WK_DATE;
```

### 4.6 관리포인트 조회

```sql
-- 특정 주차의 관리포인트 조회
SELECT MGMT_TYPE, SORT_NO, CONTENT, LINK_URL
FROM TS_INS_MGMT
WHERE MASTER_SEQ = :masterSeq
ORDER BY MGMT_TYPE, SORT_NO;

-- 하이라이트만 조회
SELECT SORT_NO, CONTENT
FROM TS_INS_MGMT
WHERE MASTER_SEQ = :masterSeq AND MGMT_TYPE = 'HIGHLIGHT'
ORDER BY SORT_NO;

-- 추천 콘텐츠만 조회 (링크 포함)
SELECT SORT_NO, CONTENT, LINK_URL
FROM TS_INS_MGMT
WHERE MASTER_SEQ = :masterSeq AND MGMT_TYPE = 'RECOMMEND'
ORDER BY SORT_NO;
```

---

## 5. 데이터 정리 쿼리

### 5.1 마스터 삭제 (CASCADE)
```sql
-- 마스터 삭제 시 하위 데이터 자동 삭제
DELETE FROM TS_INS_MASTER WHERE SEQ = :masterSeq;
```

### 5.2 기간별 데이터 정리
```sql
-- 2년 이상 된 주간 리포트 삭제
DELETE FROM TS_INS_MASTER
WHERE DAY_GB = 'WEEK'
AND DT_TO < ADD_MONTHS(SYSDATE, -24);

-- 5년 이상 된 월간 리포트 삭제
DELETE FROM TS_INS_MASTER
WHERE DAY_GB = 'MON'
AND DT_TO < ADD_MONTHS(SYSDATE, -60);
```

### 5.3 날씨 데이터 정리
```sql
-- 1년 이상 된 날씨 데이터 삭제
DELETE FROM TS_INS_WEATHER
WHERE WK_DATE < ADD_MONTHS(SYSDATE, -12);
```

### 5.4 접속 로그 정리
```sql
-- 1년 이상 된 접속 로그 삭제
DELETE FROM TS_INS_ACCESS_LOG
WHERE ACCESS_DT < ADD_MONTHS(SYSTIMESTAMP, -12);
```

---

## 6. 접속 로그 쿼리 (TS_INS_ACCESS_LOG)

### 6.1 로그 INSERT

```sql
-- 로그인 로그
INSERT INTO TS_INS_ACCESS_LOG (
    SEQ, MEMBER_ID, FARM_NO, LOG_TYPE,
    IP_ADDRESS, USER_AGENT, DEVICE_TYPE, BROWSER, OS
)
VALUES (
    SQ_TS_INS_ACCESS_LOG.NEXTVAL, :memberId, :farmNo, 'LOGIN',
    :ipAddress, :userAgent, :deviceType, :browser, :os
);

-- 로그아웃 로그
INSERT INTO TS_INS_ACCESS_LOG (SEQ, MEMBER_ID, FARM_NO, LOG_TYPE, IP_ADDRESS)
VALUES (SQ_TS_INS_ACCESS_LOG.NEXTVAL, :memberId, :farmNo, 'LOGOUT', :ipAddress);

-- 메뉴 접속 로그 (8자리 메뉴코드: WY주간, MY월간, QY분기, ST설정)
INSERT INTO TS_INS_ACCESS_LOG (SEQ, MEMBER_ID, FARM_NO, LOG_TYPE, MENU_CD)
VALUES (SQ_TS_INS_ACCESS_LOG.NEXTVAL, :memberId, :farmNo, 'MENU', :menuCd);
-- 예: 'WY000000'(주간메인), 'WY010000'(1차메뉴), 'ST000000'(설정메인)

-- 보고서 접속 로그 (리스트에서 클릭)
INSERT INTO TS_INS_ACCESS_LOG (SEQ, MEMBER_ID, FARM_NO, LOG_TYPE, REPORT_GB, REPORT_SEQ, ACCESS_GB)
VALUES (SQ_TS_INS_ACCESS_LOG.NEXTVAL, :memberId, :farmNo, 'REPORT', :reportGb, :reportSeq, 'LIST');

-- 보고서 접속 로그 (외부 링크)
INSERT INTO TS_INS_ACCESS_LOG (SEQ, MEMBER_ID, FARM_NO, LOG_TYPE, REPORT_GB, REPORT_SEQ, ACCESS_GB, REFERER)
VALUES (SQ_TS_INS_ACCESS_LOG.NEXTVAL, :memberId, :farmNo, 'REPORT', :reportGb, :reportSeq, 'LINK', :referer);

-- 보고서 접속 로그 (직접 URL)
INSERT INTO TS_INS_ACCESS_LOG (SEQ, MEMBER_ID, FARM_NO, LOG_TYPE, REPORT_GB, REPORT_SEQ, ACCESS_GB)
VALUES (SQ_TS_INS_ACCESS_LOG.NEXTVAL, :memberId, :farmNo, 'REPORT', :reportGb, :reportSeq, 'DIRECT');
```

### 6.2 통계 조회

```sql
-- 일별 로그인 통계
SELECT TO_CHAR(ACCESS_DT, 'YYYY-MM-DD') AS LOGIN_DT,
       COUNT(*) AS LOGIN_CNT,
       COUNT(DISTINCT MEMBER_ID) AS USER_CNT
FROM TS_INS_ACCESS_LOG
WHERE LOG_TYPE = 'LOGIN'
  AND ACCESS_DT >= TRUNC(SYSDATE) - 30
GROUP BY TO_CHAR(ACCESS_DT, 'YYYY-MM-DD')
ORDER BY LOGIN_DT DESC;

-- 월별 로그인 통계
SELECT YEAR, MONTH,
       COUNT(*) AS LOGIN_CNT,
       COUNT(DISTINCT MEMBER_ID) AS USER_CNT,
       COUNT(DISTINCT FARM_NO) AS FARM_CNT
FROM TS_INS_ACCESS_LOG
WHERE LOG_TYPE = 'LOGIN'
  AND YEAR = :year
GROUP BY YEAR, MONTH
ORDER BY MONTH;

-- 메뉴별 접속 통계
SELECT MENU_CD, COUNT(*) AS ACCESS_CNT
FROM TS_INS_ACCESS_LOG
WHERE LOG_TYPE = 'MENU'
  AND ACCESS_DT >= TRUNC(SYSDATE) - 30
GROUP BY MENU_CD
ORDER BY ACCESS_CNT DESC;

-- 보고서 접속 경로별 통계
SELECT ACCESS_GB,
       CASE ACCESS_GB
           WHEN 'LIST' THEN '리스트에서'
           WHEN 'LINK' THEN '외부링크'
           WHEN 'DIRECT' THEN '직접접속'
       END AS ACCESS_GB_NM,
       COUNT(*) AS ACCESS_CNT
FROM TS_INS_ACCESS_LOG
WHERE LOG_TYPE = 'REPORT'
  AND ACCESS_DT >= TRUNC(SYSDATE) - 30
GROUP BY ACCESS_GB
ORDER BY ACCESS_CNT DESC;

-- 특정 보고서 조회수
SELECT REPORT_SEQ, REPORT_GB, COUNT(*) AS VIEW_CNT
FROM TS_INS_ACCESS_LOG
WHERE LOG_TYPE = 'REPORT'
GROUP BY REPORT_SEQ, REPORT_GB
ORDER BY VIEW_CNT DESC
FETCH FIRST 10 ROWS ONLY;

-- 디바이스별 접속 통계
SELECT DEVICE_TYPE,
       COUNT(*) AS ACCESS_CNT,
       ROUND(COUNT(*) * 100.0 / SUM(COUNT(*)) OVER(), 1) AS RATE
FROM TS_INS_ACCESS_LOG
WHERE ACCESS_DT >= TRUNC(SYSDATE) - 30
GROUP BY DEVICE_TYPE
ORDER BY ACCESS_CNT DESC;

-- 브라우저별 접속 통계
SELECT BROWSER,
       COUNT(*) AS ACCESS_CNT,
       ROUND(COUNT(*) * 100.0 / SUM(COUNT(*)) OVER(), 1) AS RATE
FROM TS_INS_ACCESS_LOG
WHERE ACCESS_DT >= TRUNC(SYSDATE) - 30
GROUP BY BROWSER
ORDER BY ACCESS_CNT DESC;
```

### 6.3 사용자별 조회

```sql
-- 특정 사용자의 접속 이력
SELECT ACCESS_DT, LOG_TYPE, MENU_CD,
       REPORT_GB, REPORT_SEQ, ACCESS_GB, IP_ADDRESS, DEVICE_TYPE
FROM TS_INS_ACCESS_LOG
WHERE MEMBER_ID = :memberId
ORDER BY ACCESS_DT DESC
FETCH FIRST 100 ROWS ONLY;

-- 농장별 월간 접속 현황
SELECT FARM_NO, YEAR, MONTH, LOG_TYPE, COUNT(*) AS CNT
FROM TS_INS_ACCESS_LOG
WHERE YEAR = :year
GROUP BY FARM_NO, YEAR, MONTH, LOG_TYPE
ORDER BY FARM_NO, YEAR, MONTH;

-- 최근 로그인 사용자 목록
SELECT MEMBER_ID, FARM_NO, MAX(ACCESS_DT) AS LAST_LOGIN,
       COUNT(*) AS LOGIN_CNT
FROM TS_INS_ACCESS_LOG
WHERE LOG_TYPE = 'LOGIN'
  AND ACCESS_DT >= TRUNC(SYSDATE) - 7
GROUP BY MEMBER_ID, FARM_NO
ORDER BY LAST_LOGIN DESC;
```

### 6.4 실시간 모니터링

```sql
-- 오늘 접속 현황 대시보드
SELECT LOG_TYPE,
       COUNT(*) AS CNT,
       COUNT(DISTINCT MEMBER_ID) AS USER_CNT,
       COUNT(DISTINCT FARM_NO) AS FARM_CNT
FROM TS_INS_ACCESS_LOG
WHERE TRUNC(ACCESS_DT) = TRUNC(SYSTIMESTAMP)
GROUP BY LOG_TYPE;

-- 시간대별 접속 현황
SELECT TO_CHAR(ACCESS_DT, 'HH24') AS HOUR,
       COUNT(*) AS CNT
FROM TS_INS_ACCESS_LOG
WHERE TRUNC(ACCESS_DT) = TRUNC(SYSTIMESTAMP)
GROUP BY TO_CHAR(ACCESS_DT, 'HH24')
ORDER BY HOUR;

-- 현재 활성 사용자 (최근 30분 내 접속)
SELECT DISTINCT MEMBER_ID, FARM_NO, MAX(ACCESS_DT) AS LAST_ACCESS
FROM TS_INS_ACCESS_LOG
WHERE ACCESS_DT >= SYSTIMESTAMP - INTERVAL '30' MINUTE
GROUP BY MEMBER_ID, FARM_NO
ORDER BY LAST_ACCESS DESC;
```
