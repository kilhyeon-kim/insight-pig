# 운영 함수 참조

> 기존 운영 DB 함수 정보 요약

---

## SF_GET_MODONGB_STATUS

모돈 상태코드/상태명 반환 함수

### 파라미터

| 파라미터 | 타입 | 설명 |
|----------|------|------|
| P_CALL_GB | VARCHAR2 | 호출구분: 'CD'=상태코드, 'NM'=상태명 |
| P_WK_GUBUN | VARCHAR2 | 작업구분 (A/G/B/E/F) |
| P_SAGO_GUBUN_CD | VARCHAR2 | 사고구분코드 (050002=유산) |
| P_OUT_DT | DATE | 출고일 |
| P_IN_STATUS_CD | VARCHAR2 | 전입 상태코드 |
| P_DAERI_YN | VARCHAR2 | 대리모 여부 |
| P_LANG | VARCHAR2 | 언어코드 (ko/en/vi) |

### 반환값

| 작업구분 | 조건 | 반환 상태코드 |
|----------|------|---------------|
| - | OUT_DT != 9999-12-31 | 010008 (도폐사돈) |
| G (교배) | - | 010002 (임신돈) |
| B (분만) | - | 010003 (포유돈) |
| E (이유) | DAERI_YN = 'N' | 010005 (이유모돈) |
| E (이유) | DAERI_YN = 'Y' | 010004 (대리모돈) |
| F (사고) | SAGO_GUBUN_CD = '050002' | 010007 (유산돈) |
| F (사고) | SAGO_GUBUN_CD != '050002' | 010006 (재발돈) |
| 기타 | - | 010001 (후보돈) |

### 사용 예시

```sql
-- 상태코드 반환
SELECT SF_GET_MODONGB_STATUS('CD', 'G', NULL,
       TO_DATE('99991231', 'YYYYMMDD'), '010002', 'N', '')
FROM DUAL;
-- 결과: 010002 (임신돈)

-- 상태명 반환 (한국어)
SELECT SF_GET_MODONGB_STATUS('NM', 'B', NULL,
       TO_DATE('99991231', 'YYYYMMDD'), '010003', 'N', 'ko')
FROM DUAL;
-- 결과: 포유돈
```

---

## SF_GET_LOCALE_VW_DATE_2022

타임존 변환 함수 (다국어 지원)

### 파라미터

| 파라미터 | 타입 | 설명 |
|----------|------|------|
| LOCALE | VARCHAR2 | 로케일 (KOR/VNM) |
| IN_DATE | DATE | 입력일자 |

### 지원 로케일

| 로케일 | 타임존 |
|--------|--------|
| KOR | UTC+9 |
| VNM | UTC+7 |

---

## FN_LOC_MAX_ONE_2020

특정일 기준 모돈의 마지막 장소 조회 함수

### 용도

- 특정일 기준 모돈의 마지막 장소명 반환
- FN_MD_SCHEDULE_BSE_2020에서 LOC_NM 조회 시 사용

### 파라미터

| 파라미터 | 타입 | 설명 |
|----------|------|------|
| P_FARM_NO | INTEGER | 농장번호 |
| P_PIG_NO | INTEGER | 돼지번호 |
| P_WK_DT | VARCHAR2 | 기준일 (yyyy-MM-dd) |
| P_DATE_FORMAT | VARCHAR2 | 날짜포맷 (미사용) |

### 반환값

`VARCHAR2(200)` - 장소명 (TC_LOC.LOC_NM)

### 장소 조회 우선순위

3개 테이블에서 UNION ALL 후 마지막 작업일 기준:

| 순서 | 테이블 | 조건 |
|------|--------|------|
| 1 | TB_MODON | IN_LOC_CD > 0 (전입장소) |
| 2 | TB_MODON_WK | LOC_CD > 0 (작업장소) |
| 3 | TB_MD_LOC_TRANS | LOC_CD > 0 (장소이동) |

### 핵심 로직

```sql
MAX(LOC_CD) KEEP (DENSE_RANK LAST ORDER BY WK_DT, LOG_INS_DT)
-- 동일 날짜 내 가장 마지막 등록된 장소
```

### 사용 예시

```sql
SELECT FN_LOC_MAX_ONE_2020(1456, 12345, '2024-12-15', 'yyyy-MM-dd')
FROM DUAL;
-- 결과: '분만사 1동'
```

### 성능 고려사항

- 모돈별 1건씩 호출 → 대량 조회 시 성능 저하
- 예정돈 대장에서는 NULL 반환 후 별도 조회 권장

---

## SF_WEEK_CNT2

주차 계산 함수 (일요일/월요일 기준)

### 용도

- 특정일의 년도 내 주차 계산
- FN_MD_SCHEDULE_BSE_2020에서 AUTO_GRP 계산 시 사용

### 파라미터

| 파라미터 | 타입 | 설명 |
|----------|------|------|
| SDATE | VARCHAR2 | 날짜 (yyyy-MM-dd) |
| STYPE | VARCHAR2 | 기준요일 (NULL/'SU'=일요일, 그 외=월요일) |

### 반환값

`NUMBER` - 주차 (0부터 시작)

### 계산 로직

```sql
-- 일요일 기준 (STYPE = 'SU' 또는 NULL)
TRUNC((TRUNC(날짜) - TRUNC(TRUNC(날짜, 'YY'), 'D')) / 7)

-- 월요일 기준
TRUNC((TRUNC(날짜) - TRUNC(TRUNC(날짜, 'YY'), 'IW')) / 7)
```

### 사용 예시

```sql
-- 일요일 기준 주차
SELECT SF_WEEK_CNT2('2024-12-15', NULL) FROM DUAL;  -- 결과: 50

-- 월요일 기준 주차 (IW)
SELECT SF_WEEK_CNT2('2024-12-15', 'MO') FROM DUAL;  -- 결과: 50
```

### 대체 방법 (V2에서)

```sql
-- SF_WEEK_CNT2 대신 TO_CHAR 사용 가능
TO_CHAR(WK_DATE, 'IW')  -- ISO 주차 (월요일 기준)
LEAST(TO_CHAR(WK_DATE, 'IW'), 52)  -- 53주차는 52로 처리
```

