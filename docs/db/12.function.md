# 함수 정의서

> inspig 주간/월간 리포트 관련 함수 및 프로시저 정의

---

## 1. 유틸리티 함수

### 1.1 타임존 변환 함수 (SF_GET_LOCALE_VW_DATE_2022)

다국어 지원을 위한 타임존 변환 함수입니다. 베트남 등 해외 농장 지원 시 사용됩니다.

```sql
-- 함수 시그니처
SF_GET_LOCALE_VW_DATE_2022(LOCALE VARCHAR2, IN_DATE DATE) RETURN DATE

-- 지원 로케일
-- KOR: 한국 (UTC+9)
-- VNM: 베트남 (UTC+7)
-- 기타: 기본 UTC+9

-- 사용 예시
SELECT SF_GET_LOCALE_VW_DATE_2022('KOR', SYSDATE) FROM DUAL;
SELECT SF_GET_LOCALE_VW_DATE_2022('VNM', SYSDATE) FROM DUAL;
```

리포트 생성 시 해외 농장의 경우 이 함수를 사용하여 로컬 시간 기준으로 날짜를 처리합니다.

---

## 2. 주간 리포트 생성 프로시저

### 2.1 SP_INS_WEEKLY_REPORT_GEN

주간 리포트 데이터를 생성하는 메인 프로시저입니다.

```sql
CREATE OR REPLACE PROCEDURE SP_INS_WEEKLY_REPORT_GEN (
    p_target_date IN DATE DEFAULT NULL  -- NULL이면 지난주 기준
) AS
    v_week_start    DATE;
    v_week_end      DATE;
    v_year          NUMBER(4);
    v_week_no       NUMBER(2);
    v_json          CLOB;

    -- 커서: 활성 농장 목록
    CURSOR cur_farms IS
        SELECT FARM_NO, FARM_NM
        FROM TA_FARM
        WHERE USE_YN = 'Y'
        AND TEST_YN = 'N'
        AND STOP_DT > SYSDATE;

BEGIN
    -- 대상 주차 계산 (월요일 ~ 일요일)
    IF p_target_date IS NULL THEN
        v_week_start := TRUNC(SYSDATE, 'IW') - 7;  -- 지난주 월요일
    ELSE
        v_week_start := TRUNC(p_target_date, 'IW');
    END IF;
    v_week_end := v_week_start + 6;  -- 일요일

    v_year := TO_NUMBER(TO_CHAR(v_week_start, 'YYYY'));
    v_week_no := TO_NUMBER(TO_CHAR(v_week_start, 'IW'));

    -- 농장별 리포트 생성
    FOR farm_rec IN cur_farms LOOP
        -- 기존 데이터 삭제 (MERGE 대신 DELETE + INSERT)
        DELETE FROM TS_INS_WEEKLY_REPORT
        WHERE FARM_NO = farm_rec.FARM_NO
        AND REPORT_WEEK = v_week_start;

        -- 집계 및 INSERT (마스터)
        INSERT INTO TS_INS_WEEKLY_REPORT (
            FARM_NO, REPORT_WEEK, REPORT_YEAR, REPORT_WEEK_NO,
            MODON_TOTAL, MODON_ACTIVE,
            LAST_GYOBAE_CNT, LAST_BUNMAN_CNT, LAST_BUNMAN_TOTAL, LAST_BUNMAN_ALIVE,
            LAST_EU_CNT, LAST_EU_DUSU, LAST_SAGO_CNT,
            THIS_GYOBAE_CNT, THIS_BUNMAN_CNT, THIS_EU_CNT, THIS_VACCINE_CNT,
            DETAIL_JSON
        )
        SELECT
            farm_rec.FARM_NO,
            v_week_start,
            v_year,
            v_week_no,
            -- 모돈 현황
            (SELECT COUNT(*) FROM TB_MODON
             WHERE FARM_NO = farm_rec.FARM_NO AND USE_YN = 'Y'),
            (SELECT COUNT(*) FROM TB_MODON
             WHERE FARM_NO = farm_rec.FARM_NO AND USE_YN = 'Y'
             AND OUT_DT > SYSDATE),
            -- 지난주 교배
            (SELECT COUNT(DISTINCT PIG_NO) FROM TB_MODON_WK
             WHERE FARM_NO = farm_rec.FARM_NO
             AND WK_GUBUN = 'G' AND USE_YN = 'Y'
             AND WK_DATE BETWEEN v_week_start AND v_week_end),
            -- 지난주 분만
            (SELECT COUNT(DISTINCT PIG_NO) FROM TB_MODON_WK
             WHERE FARM_NO = farm_rec.FARM_NO
             AND WK_GUBUN = 'B' AND USE_YN = 'Y'
             AND WK_DATE BETWEEN v_week_start AND v_week_end),
            -- 총산/생존 (TB_BUNMAN에서 조회 필요)
            0, 0,
            -- 지난주 이유
            (SELECT COUNT(DISTINCT PIG_NO) FROM TB_MODON_WK
             WHERE FARM_NO = farm_rec.FARM_NO
             AND WK_GUBUN = 'E' AND USE_YN = 'Y'
             AND WK_DATE BETWEEN v_week_start AND v_week_end),
            (SELECT NVL(SUM(DUSU + NVL(DUSU_SU, 0)), 0) FROM TB_EU
             WHERE FARM_NO = farm_rec.FARM_NO AND USE_YN = 'Y'
             AND TO_DATE(WK_DT, 'YYYYMMDD') BETWEEN v_week_start AND v_week_end),
            -- 지난주 사고
            (SELECT COUNT(*) FROM TB_SAGO
             WHERE FARM_NO = farm_rec.FARM_NO AND USE_YN = 'Y'
             AND TO_DATE(WK_DT, 'YYYYMMDD') BETWEEN v_week_start AND v_week_end),
            -- 금주 예정 (TB_PLAN_MODON 기반 계산 필요)
            0, 0, 0, 0,
            -- JSON (별도 함수로 생성)
            FN_INS_BUILD_WEEKLY_JSON(farm_rec.FARM_NO, v_week_start, v_week_end)
        FROM DUAL;

    END LOOP;

    COMMIT;

EXCEPTION
    WHEN OTHERS THEN
        ROLLBACK;
        RAISE;
END SP_INS_WEEKLY_REPORT_GEN;
/
```

---

### 2.2 FN_INS_BUILD_WEEKLY_JSON

주간 리포트 상세 데이터를 JSON 형식으로 생성하는 함수입니다.

```sql
CREATE OR REPLACE FUNCTION FN_INS_BUILD_WEEKLY_JSON (
    p_farm_no   IN INTEGER,
    p_week_start IN DATE,
    p_week_end   IN DATE
) RETURN CLOB
AS
    v_json CLOB;
BEGIN
    -- JSON_OBJECT 사용하여 구조화된 JSON 생성
    SELECT JSON_OBJECT(
        'header' VALUE JSON_OBJECT(
            'farmName' VALUE (SELECT FARM_NM FROM TA_FARM WHERE FARM_NO = p_farm_no),
            'reportDate' VALUE TO_CHAR(p_week_start, 'YYYY.MM.DD') || ' ~ ' || TO_CHAR(p_week_end, 'MM.DD'),
            'weekNumber' VALUE TO_NUMBER(TO_CHAR(p_week_start, 'IW'))
        ),
        'lastWeek' VALUE JSON_OBJECT(
            'gyobae' VALUE JSON_OBJECT(
                'count' VALUE (
                    SELECT COUNT(DISTINCT PIG_NO)
                    FROM TB_MODON_WK
                    WHERE FARM_NO = p_farm_no
                    AND WK_GUBUN = 'G' AND USE_YN = 'Y'
                    AND WK_DATE BETWEEN p_week_start AND p_week_end
                )
            )
            -- ... 추가 데이터
        )
        RETURNING CLOB
    )
    INTO v_json
    FROM DUAL;

    RETURN v_json;
END FN_INS_BUILD_WEEKLY_JSON;
/
```

---

## 3. 농가별 설정 조회

### 3.1 농가 설정 조회 쿼리

```sql
-- 특정 농가의 모든 설정 조회
SELECT
    fc.CODE,
    cs.CNAME AS CODE_NAME,
    fc.CVALUE,
    fc.CVALUE_2
FROM TC_FARM_CONFIG fc
JOIN TC_CODE_SYS cs ON fc.CODE = cs.CODE AND cs.LANGUAGE_CD = 'ko'
WHERE fc.FARM_NO = :farmNo
AND fc.USE_YN = 'Y';

-- 임신기간 설정값 조회 (기본값 114)
SELECT NVL(
    (SELECT TO_NUMBER(CVALUE) FROM TC_FARM_CONFIG
     WHERE FARM_NO = :farmNo AND CODE = '901001' AND USE_YN = 'Y'),
    114
) AS GESTATION_DAYS
FROM DUAL;

-- 금주 분만예정 계산 (교배일 + 임신기간)
SELECT m.FARM_PIG_NO, mw.WK_DATE AS MATING_DATE,
       mw.WK_DATE + NVL(fc.CVALUE, 114) AS EXPECTED_FARROWING
FROM TB_MODON m
JOIN TB_MODON_WK mw ON m.FARM_NO = mw.FARM_NO AND m.PIG_NO = mw.PIG_NO
LEFT JOIN TC_FARM_CONFIG fc ON m.FARM_NO = fc.FARM_NO AND fc.CODE = '901001'
WHERE m.FARM_NO = :farmNo
AND mw.WK_GUBUN = 'G'
AND m.STATUS_CD = '임신'  -- 임신 상태코드
AND mw.WK_DATE + NVL(TO_NUMBER(fc.CVALUE), 114) BETWEEN :weekStart AND :weekEnd;
```

### 3.2 농가별 설정을 반영한 예정 작업 계산

```sql
-- 농가별 설정을 반영한 금주 예정 작업 계산
WITH farm_config AS (
    SELECT
        FARM_NO,
        MAX(CASE WHEN CODE = '901001' THEN TO_NUMBER(CVALUE) END) AS GESTATION_DAYS,
        MAX(CASE WHEN CODE = '901002' THEN TO_NUMBER(CVALUE) END) AS LACTATION_DAYS,
        MAX(CASE WHEN CODE = '901003' THEN TO_NUMBER(CVALUE) END) AS WEAN_TO_MATE_DAYS
    FROM TC_FARM_CONFIG
    WHERE USE_YN = 'Y'
    GROUP BY FARM_NO
)
SELECT
    m.FARM_NO,
    -- 분만 예정 (교배일 + 임신기간)
    COUNT(CASE WHEN m.STATUS_CD = '임신'
               AND last_gb.WK_DATE + NVL(fc.GESTATION_DAYS, 114) BETWEEN :weekStart AND :weekEnd
          THEN 1 END) AS THIS_BUNMAN_CNT,
    -- 이유 예정 (분만일 + 포유기간)
    COUNT(CASE WHEN m.STATUS_CD = '포유'
               AND last_bm.WK_DATE + NVL(fc.LACTATION_DAYS, 21) BETWEEN :weekStart AND :weekEnd
          THEN 1 END) AS THIS_EU_CNT
FROM TB_MODON m
LEFT JOIN farm_config fc ON m.FARM_NO = fc.FARM_NO
LEFT JOIN (
    SELECT FARM_NO, PIG_NO, MAX(WK_DATE) AS WK_DATE
    FROM TB_MODON_WK WHERE WK_GUBUN = 'G' AND USE_YN = 'Y'
    GROUP BY FARM_NO, PIG_NO
) last_gb ON m.FARM_NO = last_gb.FARM_NO AND m.PIG_NO = last_gb.PIG_NO
LEFT JOIN (
    SELECT FARM_NO, PIG_NO, MAX(WK_DATE) AS WK_DATE
    FROM TB_MODON_WK WHERE WK_GUBUN = 'B' AND USE_YN = 'Y'
    GROUP BY FARM_NO, PIG_NO
) last_bm ON m.FARM_NO = last_bm.FARM_NO AND m.PIG_NO = last_bm.PIG_NO
WHERE m.FARM_NO = :farmNo
AND m.USE_YN = 'Y'
AND m.OUT_DT > SYSDATE
GROUP BY m.FARM_NO;
```

---

## 4. 출하 관련 집계 쿼리

### 4.1 주간 출하 현황 집계

```sql
SELECT
    FARM_NO,
    COUNT(*) AS SHIP_CNT,                              -- 출하 두수
    ROUND(AVG(NET_KG), 1) AS AVG_CARCASS,             -- 평균 도체중
    ROUND(AVG(BACK_DEPTH), 1) AS AVG_BACKFAT,         -- 평균 등지방
    SUM(CASE WHEN MEAT_QUALITY IN ('1+', '1') THEN 1 ELSE 0 END) AS GRADE_1_CNT,  -- 1등급 두수
    ROUND(AVG(AU_PRICE), 0) AS AVG_PRICE              -- 평균 경락가
FROM TM_LPD_DATA
WHERE FARM_NO = :farmNo
AND DOCHUK_DT BETWEEN :weekStart AND :weekEnd
AND USE_YN = 'Y'
GROUP BY FARM_NO;
```

### 4.2 등급별 분포

```sql
SELECT
    MEAT_QUALITY,
    COUNT(*) AS CNT
FROM TM_LPD_DATA
WHERE FARM_NO = :farmNo
AND DOCHUK_DT BETWEEN :weekStart AND :weekEnd
AND USE_YN = 'Y'
GROUP BY MEAT_QUALITY
ORDER BY
    CASE MEAT_QUALITY
        WHEN '1+' THEN 1
        WHEN '1' THEN 2
        WHEN '2' THEN 3
        ELSE 4
    END;
```

### 4.3 도체분포 차트용 (산점도)

```sql
SELECT
    NET_KG AS CARCASS_KG,
    BACK_DEPTH AS BACKFAT_MM,
    COUNT(*) AS CNT
FROM TM_LPD_DATA
WHERE FARM_NO = :farmNo
AND DOCHUK_DT BETWEEN :weekStart AND :weekEnd
AND USE_YN = 'Y'
GROUP BY NET_KG, BACK_DEPTH;
```
