# inspig 통계 테이블 정의서

> inspig 주간/월간/분기 리포트용 통계 테이블 정의

---

## 1. 개요

### 1.1 DDL 스크립트 위치

| 파일 | 설명 | 실행 순서 |
|------|------|----------|
| [sql/00_SEQUENCE.sql](sql/00_SEQUENCE.sql) | 시퀀스 생성 | 1 |
| [sql/01_TABLE.sql](sql/01_TABLE.sql) | 테이블 생성 | 2 |
| [sql/02_SP_INS_COM_LOG.sql](sql/02_SP_INS_COM_LOG.sql) | 공통 로그 프로시저 | 3 |
| [sql/03_SP_INS_WEEK_MAIN.sql](sql/03_SP_INS_WEEK_MAIN.sql) | 주간 리포트 메인 프로시저 | 4 |
| [sql/04_SP_INS_WEEK_MANAGE_SOW.sql](sql/04_SP_INS_WEEK_MANAGE_SOW.sql) | 관리대상 모돈 프로시저 | 5 |
| [sql/05_JOB_INS_WEEKLY.sql](sql/05_JOB_INS_WEEKLY.sql) | 스케줄러 JOB 생성 | 6 |

### 1.2 테이블 구조

```
┌──────────────────────────┐     ┌─────────────────────────────────────┐
│    TS_INS_SERVICE        │     │          TS_INS_MASTER              │
│  - 서비스 신청 농장       │     │  - 주/월별 리포트 생성 기준 정보     │
│  - FK → TA_FARM          │     │  - 대상수, 완료수, 생성상태          │
└────────────┬─────────────┘     └──────────────────┬──────────────────┘
             │ 1:N                                   │ 1:N (DAY_GB별 분기)
             │         ┌─────────────────────────────┤
             │         │                             │
             ▼         ▼                             ▼
┌─────────────────────────────┐  ┌──────────────┐  ┌──────────────┐
│      TS_INS_WEEK (주간)      │  │ TS_INS_MON   │  │  TS_INS_QT   │
│  - PK: (MASTER_SEQ, FARM_NO) │  │   (월간)     │  │   (분기)     │
│  - FK: MASTER_SEQ            │  │   [추후]     │  │   [추후]     │
│  - FK: FARM_NO               │  └──────────────┘  └──────────────┘
└─────────────────────────┬───┘
                          │ 1:N
                          ▼
┌─────────────────────────────────────────────────────────────┐
│                  TS_INS_WEEK_SUB (상세)                       │
│  - 각 팝업별 리스트 데이터 (주간/월간/분기 공용)               │
│  - GUBUN으로 데이터 유형 구분                                 │
└─────────────────────────────────────────────────────────────┘
```

### 1.3 테이블 분류

#### 공통 테이블
| 테이블명 | 설명 | 용도 |
|----------|------|------|
| `TA_SYS_CONFIG` | 시스템 설정 테이블 | 인사이트피그플랜 시스템 전반 설정 |
| `TS_INS_SERVICE` | 서비스 신청 테이블 | 인사이트피그플랜 서비스 신청 정보 |
| `TS_INS_MASTER` | 리포트 생성 마스터 | 주/월/분기 리포트 생성 기준, 대상수, 완료수 |
| `TS_INS_JOB_LOG` | 스케줄러 로그 테이블 | 프로시저 실행 상태 및 오류 기록 |
| `TS_PSY_DELAY_HEATMAP` | PSY 히트맵 테이블 | PSY & 입력지연일 기준 농장 분포 |
| `TM_WEATHER` | 날씨 테이블 | 기상청 날씨 정보 |
| `TS_INS_ACCESS_LOG` | 접속 로그 테이블 | 로그인/메뉴/보고서 접속 로그 통합 |

#### 주간 리포트 테이블 (WEEK)
| 테이블명 | 설명 | 용도 |
|----------|------|------|
| `TS_INS_WEEK` | 주간 리포트 테이블 | 주간 보고서 요약 데이터 |
| `TS_INS_WEEK_SUB` | 리포트 상세 테이블 | 각 팝업별 리스트 데이터 (공용) |
| `TS_INS_MGMT` | 관리포인트 테이블 | 주간 관리포인트 (하이라이트, 추천) |

#### 월간/분기 리포트 테이블 (추후 추가)
| 테이블명 | 설명 | 용도 |
|----------|------|------|
| `TS_INS_MON` | 월간 리포트 테이블 | 월간 보고서 요약 데이터 (추후) |
| `TS_INS_QT` | 분기 리포트 테이블 | 분기 보고서 요약 데이터 (추후) |

### 1.4 관련 문서
- [10.table.md](10.table.md) - 원본 테이블 정의
- [22.insQuery.md](22.insQuery.md) - 데이터 활용 쿼리
- [23.procedure.md](23.procedure.md) - 프로시저 정의

---

## 2. 테이블 상세

### 2.1 TA_SYS_CONFIG (시스템 설정)

시스템 전반에 대한 공통 설정을 관리합니다. **1개 row에 모든 설정을 컬럼으로 저장**합니다.

| 컬럼명 | 데이터타입 | 설명 | 비고 |
|--------|-----------|------|------|
| `SEQ` | NUMBER | 일련번호 | PK (항상 1) |
| `MODON_HIST_YN` | VARCHAR2(1) | 모돈이력제 연계여부 | Y/N, 기본값 'N' |
| `EKAPE_YN` | VARCHAR2(1) | 축평원 연계여부 | Y/N, 기본값 'N' |
| `INS_SCHEDULE_YN` | VARCHAR2(1) | 인사이트피그플랜 스케줄 실행여부 | Y/N, 기본값 'Y' |
| `LOG_INS_DT` | DATE | 생성일 | SYSDATE |
| `LOG_UPT_DT` | DATE | 수정일 | SYSDATE |

---

### 2.2 TS_INS_SERVICE (서비스 신청)

인사이트피그플랜 서비스 신청 정보를 관리합니다.

| 컬럼명 | 데이터타입 | 설명 | 비고 |
|--------|-----------|------|------|
| `FARM_NO` | INTEGER | 농장번호 | PK, FK → TA_FARM |
| `INSPIG_YN` | VARCHAR2(1) | 서비스 신청여부 | Y/N, 기본값 'N' |
| `INSPIG_REG_DT` | VARCHAR2(8) | 서비스 신청일 | YYYYMMDD |
| `INSPIG_FROM_DT` | VARCHAR2(8) | 서비스 시작일 | YYYYMMDD |
| `INSPIG_TO_DT` | VARCHAR2(8) | 서비스 종료일 | YYYYMMDD, NULL이면 무기한 |
| `INSPIG_STOP_DT` | VARCHAR2(8) | 서비스 중단일 | YYYYMMDD, NULL이면 정상 |
| `WEB_PAY_YN` | VARCHAR2(1) | 웹결재 여부 | Y/N |
| `USE_YN` | VARCHAR2(1) | 사용여부 | 기본값 'Y' |

---

### 2.3 TS_INS_MASTER (리포트 마스터)

주/월별 리포트 생성 기준 정보를 관리합니다.

| 컬럼명 | 데이터타입 | 설명 | 비고 |
|--------|-----------|------|------|
| `SEQ` | NUMBER | 일련번호 | PK, 시퀀스 |
| `DAY_GB` | VARCHAR2(10) | 기간구분 | WEEK/MON/QT |
| `INS_DT` | CHAR(8) | 생성기준일 | YYYYMMDD |
| `REPORT_YEAR` | NUMBER(4) | 년도 | |
| `REPORT_WEEK_NO` | NUMBER(2) | 주차/월 | 1~53 또는 1~12 |
| `DT_FROM` | VARCHAR2(8) | 시작일 | YYYYMMDD |
| `DT_TO` | VARCHAR2(8) | 종료일 | YYYYMMDD |
| `TARGET_CNT` | INTEGER | 대상 농장수 | 실시간 업데이트 |
| `COMPLETE_CNT` | INTEGER | 완료 농장수 | 실시간 업데이트 |
| `ERROR_CNT` | INTEGER | 오류 농장수 | 실시간 업데이트 |
| `STATUS_CD` | VARCHAR2(10) | 상태 | READY/RUNNING/COMPLETE/ERROR |
| `START_DT` | DATE | 시작일시 | |
| `END_DT` | DATE | 종료일시 | |
| `ELAPSED_SEC` | INTEGER | 소요시간(초) | |

**중복 방지:**
- 유니크 인덱스: `(DAY_GB, REPORT_YEAR, REPORT_WEEK_NO)`
- WEEK: 동일 년도+주차에 1회만 생성
- MON: 동일 년도+월에 1회만 생성
- QT: 동일 년도+분기에 1회만 생성

**DAY_GB 코드:**
| 코드 | 설명 | 생성 주기 |
|------|------|----------|
| WEEK | 주간 리포트 | 매주 월요일 03:00 |
| MON | 월간 리포트 | 매월 1일 04:00 |
| QT | 분기 리포트 | 분기 첫째날 05:00 |

---

### 2.4 TS_INS_JOB_LOG (실행 로그)

각 프로시저의 실행 상태를 기록합니다. **오류 정보는 이 테이블에서 통합 관리**합니다.

> **주의**: 당일 로그만 유지합니다. 매일 JOB 실행 전 전일 로그를 삭제합니다.

| 컬럼명 | 데이터타입 | 설명 | 비고 |
|--------|-----------|------|------|
| `SEQ` | NUMBER | 일련번호 | PK |
| `MASTER_SEQ` | NUMBER | 마스터 시퀀스 | FK, NULL 허용 |
| `JOB_NM` | VARCHAR2(50) | JOB 이름 | |
| `PROC_NM` | VARCHAR2(50) | 프로시저명 | |
| `FARM_NO` | INTEGER | 농장번호 | NULL=전체 |
| `STATUS_CD` | VARCHAR2(10) | 상태 | RUNNING/SUCCESS/ERROR |
| `START_DT` | DATE | 시작일시 | |
| `END_DT` | DATE | 종료일시 | |
| `ELAPSED_MS` | INTEGER | 소요시간(ms) | |
| `PROC_CNT` | INTEGER | 처리 건수 | |
| `ERROR_CD` | VARCHAR2(20) | 오류 코드 | SQLCODE |
| `ERROR_MSG` | VARCHAR2(4000) | 오류 메시지 | SQLERRM |

---

### 2.5 TS_INS_WEEK (주간 리포트)

농장별 주간 보고서의 요약 데이터를 저장합니다. (월간: TS_INS_MON, 분기: TS_INS_QT 별도)

#### 주요 컬럼 그룹

| 그룹 | 접두어 | 설명 |
|------|--------|------|
| 모돈 현황 | `MODON_` | 현재모돈수, 상시모돈수 |
| 관리대상 모돈 | `ALERT_` | 미교배, 분만지연, 이유지연 등 |
| 지난주 교배 | `LAST_GB_` | 교배 복수, 누계 |
| 지난주 분만 | `LAST_BM_` | 분만 복수, 총산, 실산, 평균 등 |
| 지난주 이유 | `LAST_EU_` | 이유 복수, 이유자돈수, 평균체중 |
| 지난주 임신사고 | `LAST_SG_` | 사고 두수, 누계 |
| 지난주 도태폐사 | `LAST_CL_` | 도폐 두수, 누계 |
| 지난주 출하 | `LAST_SH_` | 출하 두수, 평균 도체중 |
| 금주 예정 | `THIS_` | 교배/분만/이유/백신/출하 예정 |
| KPI | `KPI_` | PSY, 입력지연일 |
| PSY 히트맵 | `PSY_` | X좌표, Y좌표, 구간코드 |

**STATUS_CD:**
| 코드 | 설명 |
|------|------|
| READY | 대기 (초기 생성) |
| RUNNING | 실행중 |
| COMPLETE | 완료 |
| ERROR | 오류 (상세는 TS_INS_JOB_LOG 참조) |

---

### 2.6 TS_INS_WEEK_SUB (리포트 상세)

각 팝업별 상세 리스트 데이터를 저장합니다. `GUBUN` 컬럼으로 데이터 유형을 구분합니다.

#### GUBUN 코드 정의

| GUBUN | 설명 | CODE_1 | CNT_1~6 용도 |
|-------|------|--------|-------------|
| **ALERT** | 관리대상 모돈 | 기간(~3,4~7,8~14,14~) | 후보,이유미,사고미,분만지연,이유지연 |
| **MODON** | 모돈 현황 | 산차(후보돈,0산~9산↑) | 후보,임신,포유,이유모,사고,증감 |
| **MATING_T** | 교배 유형별 | 유형코드 | 계획,실적 |
| **MATING_C** | 교배 재귀일차트 | 재귀일(7,10,15...) | 두수 |
| **FARROWING** | 분만 성적 | 항목코드 | 합계 |
| **WEANING** | 이유 성적 | 항목코드 | 합계 |
| **ACCIDENT_T** | 임신사고 원인별 | 원인코드 | 금주,누계 |
| **ACCIDENT_C** | 임신사고 임신일차트 | 임신일(~7,8~10...) | 두수 |
| **CULLING_S** | 도태폐사 유형요약 | - | 도태,폐사,전출,매각 |
| **CULLING_T** | 도태폐사 원인별 | 원인코드 | 금주,누계 |
| **SHIP_M** | 출하 현황요약 | - | 총두수,1+,1,2,등외 |
| **SHIP_G** | 출하 등급분포 | 등급코드 | 두수 |
| **SHIP_D** | 출하 일별상세 | - | 두수 |
| **SHIP_C** | 출하 도체분포차트 | - | 두수 |
| **SCHEDULE** | 작업예정 | 유형 | 두수 |
| **CALENDAR** | 캘린더 일별 | 작업유형 | 두수 |

---

### 2.7 TS_PSY_DELAY_HEATMAP (PSY 히트맵)

PSY & 입력지연일 기준 농장 분포를 저장합니다.

| X (입력지연일) | Y (PSY) | ZONE_CD | 설명 |
|---------------|---------|---------|------|
| 0 (0~3일) | 3 (상위) | 1A | 우수 |
| 0 (0~3일) | 2 | 1B | 양호 |
| 0 (0~3일) | 1 | 1C | 보통 |
| 0 (0~3일) | 0 (하위) | 1D | 관리필요 |
| 1 (4~7일) | ... | 2A~2D | ... |
| 2 (8~14일) | ... | 3A~3D | ... |
| 3 (14일~) | ... | 4A~4D | ... |

---

### 2.8 TM_WEATHER (날씨)

농장 위치 기반 기상청 날씨 정보를 저장합니다.

| 컬럼명 | 데이터타입 | 설명 | 비고 |
|--------|-----------|------|------|
| `SEQ` | NUMBER | 일련번호 | PK |
| `WK_DATE` | VARCHAR2(8) | 날짜 | YYYYMMDD |
| `SIGUNGU_CD` | VARCHAR2(10) | 시군구코드 | 행정표준코드, UK |
| `NX`, `NY` | NUMBER | 기상청 격자좌표 | |
| `WEATHER_CD` | VARCHAR2(20) | 날씨코드 | sunny, cloudy, rainy, snow |
| `TEMP_HIGH` | NUMBER | 최고기온(℃) | |
| `TEMP_LOW` | NUMBER | 최저기온(℃) | |
| `RAIN_PROB` | NUMBER | 강수확률(%) | |

---

### 2.9 TS_INS_MGMT (관리포인트)

주간 관리포인트 정보를 저장합니다.

| MGMT_TYPE | 설명 | 비고 |
|-----------|------|------|
| HIGHLIGHT | 주요 관리포인트 | 금주 주요 관리사항 |
| RECOMMEND | 추천 콘텐츠 | 참고자료, 웨비나, 매뉴얼 등 |

---

### 2.10 TS_INS_ACCESS_LOG (접속 로그)

로그인, 메뉴, 보고서 접속 로그를 통합 관리합니다. **보관기간: 1년**

#### 기본 컬럼

| 컬럼명 | 데이터타입 | 설명 | 비고 |
|--------|-----------|------|------|
| `SEQ` | NUMBER | 일련번호 | PK |
| `MEMBER_ID` | VARCHAR2(40) | 회원ID | NOT NULL |
| `FARM_NO` | INTEGER | 농장번호 | NOT NULL |
| `LOG_TYPE` | VARCHAR2(20) | 로그유형 | LOGIN/LOGOUT/MENU/REPORT |
| `ACCESS_DT` | TIMESTAMP | 접속일시 | |
| `YEAR` | VARCHAR2(4) | 년도 | 가상컬럼 |
| `MONTH` | VARCHAR2(2) | 월 | 가상컬럼 |

#### LOG_TYPE별 사용 컬럼

| LOG_TYPE | 설명 | 사용 컬럼 |
|----------|------|----------|
| **LOGIN** | 로그인 | - |
| **LOGOUT** | 로그아웃 | - |
| **MENU** | 메뉴 접속 | `MENU_CD` |
| **REPORT** | 보고서 접속 | `REPORT_GB`, `REPORT_SEQ`, `ACCESS_GB` |

#### 상세 컬럼

| 컬럼명 | 데이터타입 | 설명 | 비고 |
|--------|-----------|------|------|
| `MENU_CD` | VARCHAR2(50) | 메뉴코드 | 8자리 코드 (아래 규칙 참조) |
| `REPORT_GB` | VARCHAR2(10) | 보고서구분 | WEEK/MON/QT |
| `REPORT_SEQ` | NUMBER | 보고서 일련번호 | FK → TS_INS_MASTER.SEQ |
| `ACCESS_GB` | VARCHAR2(10) | 접속경로 | LIST/LINK/DIRECT |

#### MENU_CD (메뉴코드 규칙)

8자리 코드 체계: `XX000000`

**1-2자리: 메뉴 구분**
| 접두어 | URL | 설명 |
|--------|-----|------|
| WY | /weekly | 주간 보고서 |
| MY | /monthly | 월간 보고서 |
| QY | /quarterly | 분기 보고서 |
| ST | /settings | 환경설정 |

**3-4자리: 1차 메뉴 (01~99)**
**5-6자리: 2차 메뉴 (01~99)**
**7-8자리: 3차 메뉴 (01~99)**

**코드 예시**
```
WY000000  - 주간보고서 메인
WY010000  - 주간보고서 > 1차 메뉴
WY010100  - 주간보고서 > 1차 메뉴 > 2차 메뉴
WY010101  - 주간보고서 > 1차 메뉴 > 2차 메뉴 > 3차 메뉴

MY000000  - 월간보고서 메인
MY010000  - 월간보고서 > 1차 메뉴

QY000000  - 분기보고서 메인

ST000000  - 환경설정 메인
ST010000  - 환경설정 > 1차 메뉴
```

#### ACCESS_GB (보고서 접속 경로)

| 코드 | 설명 | 예시 |
|------|------|------|
| LIST | 리스트에서 클릭 | 주간보고서 목록에서 클릭 |
| LINK | 외부 링크 접속 | 카카오톡, 이메일 링크 |
| DIRECT | 직접 URL 입력 | URL 직접 입력 또는 북마크 |

#### 접속 환경 컬럼

| 컬럼명 | 데이터타입 | 설명 | 비고 |
|--------|-----------|------|------|
| `IP_ADDRESS` | VARCHAR2(45) | IP 주소 | IPv6 지원 |
| `USER_AGENT` | VARCHAR2(500) | User Agent | |
| `DEVICE_TYPE` | VARCHAR2(20) | 디바이스 | PC/MOBILE/TABLET |
| `BROWSER` | VARCHAR2(50) | 브라우저 | Chrome/Safari 등 |
| `OS` | VARCHAR2(50) | 운영체제 | Windows/iOS/Android 등 |
| `REFERER` | VARCHAR2(500) | 이전 페이지 URL | |

---

## 3. 참고사항

### 3.1 데이터 규모 예상

| 테이블 | 연간 예상 건수 | 산출 근거 |
|--------|---------------|----------|
| TS_INS_MASTER | 68건 | 52(주간) + 12(월간) + 4(분기) |
| TS_INS_WEEK | 52,000건 | 주간 마스터 1건 × 농장 1,000개 |
| TS_INS_WEEK_SUB | 7,000,000건 | 리포트 1건 × 약 100~150건 |
| TS_INS_ACCESS_LOG | 3,650,000건 | 농장 1,000개 × 일 10건 × 365일 |

### 3.2 인덱스 전략

| 테이블 | 인덱스 | 용도 |
|--------|--------|------|
| TS_INS_MASTER | UK(DAY_GB, REPORT_YEAR, REPORT_WEEK_NO) | 중복 체크 |
| TS_INS_WEEK | IDX(FARM_NO, MASTER_SEQ) | 농장별 조회 |
| TS_INS_WEEK_SUB | IDX(MASTER_SEQ, FARM_NO, GUBUN) | 팝업 데이터 조회 |
| TS_INS_JOB_LOG | IDX(MASTER_SEQ, FARM_NO, STATUS_CD) | 오류 조회 |
| TS_INS_ACCESS_LOG | IDX(MEMBER_ID, ACCESS_DT) | 사용자별 접속 이력 |
| TS_INS_ACCESS_LOG | IDX(FARM_NO, ACCESS_DT) | 농장별 접속 이력 |
| TS_INS_ACCESS_LOG | IDX(LOG_TYPE, ACCESS_DT) | 로그유형별 조회 |
| TS_INS_ACCESS_LOG | IDX(YEAR, MONTH) | 월별 통계 |
| TS_INS_ACCESS_LOG | IDX(REPORT_GB, REPORT_SEQ) | 보고서별 조회수 |

### 3.3 데이터 보관 정책

| 유형 | 보관 기간 | 비고 |
|------|----------|------|
| 주간 (WEEK) | 2년 | |
| 월간 (MON) | 5년 | |
| 분기 (QT) | 10년 | |
| JOB_LOG | 6개월 | 주간/월간/분기 모두 포함, 대시보드 모니터링용 |
| ACCESS_LOG | 1년 | 접속 통계 분석용 |

### 3.4 이슈 및 특이사항

1. **Oracle 19c**: `COMMENT ON SEQUENCE` 미지원으로 시퀀스 주석은 SQL 파일 내 인라인 주석으로 대체
2. **오류 로깅 통합**: `TS_INS_WEEK.ERROR_MSG` 제거, `TS_INS_JOB_LOG`에서 통합 관리
3. **실시간 진행현황**: `TS_INS_MASTER.COMPLETE_CNT`, `ERROR_CNT`는 농장 처리 완료 시마다 실시간 업데이트
