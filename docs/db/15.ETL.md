# ETL 프로세스 정의서

> 피그플랜 연간 성적 집계 ETL 프로세스 정의

---

## 1. 개요

### 1.1 목적
- 피그플랜 전체 농가의 **연간 롤링 성적**을 매일 집계
- 농가별, 산차별, 모돈별 성적 데이터를 분석하여 벤치마킹 기준 제공
- inspig 주간/월간 리포트에서 1년간 통계 비교 시 활용

### 1.2 ETL vs 주간리포트 비교

| 구분 | ETL (본 문서) | 주간리포트 (13.weekly.md) |
|------|---------------|--------------------------|
| 실행 주기 | 매일 02:00 KST | 매주 월요일 03:00 |
| 분석 기간 | **1년 롤링** | 1주일 |
| 데이터 기준 | 월 단위 확정 (15일 기점) | 주 단위 실시간 |
| 용도 | 연간 성적 비교, 벤치마킹 | 주간 실적 모니터링 |
| 실행 방식 | Python 스크립트 | Oracle Scheduler |

### 1.3 관련 문서
- [10.table.md](10.table.md) - 원본 테이블 정의
- [13.weekly.md](13.weekly.md) - 주간 리포트 구현 가이드
- [14.insTable.md](14.insTable.md) - 통계 테이블 DDL

---

## 2. 실행 조건

### 2.1 실행 스케줄
```
실행 시점: 매일 새벽 02:00 KST (UTC 17:00)
실행 방식: Python 스크립트 (외부 스케줄러)
```

### 2.2 분석 기준일 결정 로직

```
┌─────────────────────────────────────────────────────────────┐
│                    분석 기준일 결정                          │
├─────────────────────────────────────────────────────────────┤
│  오늘이 15일 이후?                                          │
│     ├─ YES → 기준일 = 전월 말일                             │
│     │         분석기간 = 전월말 기준 과거 1년               │
│     │                                                       │
│     └─ NO  → 기준일 = 전전월 말일                           │
│              분석기간 = 전전월말 기준 과거 1년              │
└─────────────────────────────────────────────────────────────┘
```

**예시 (실행일: 2024년 12월 8일)**
- 12월 8일 < 15일 이므로 → 기준일 = **2024년 10월 31일**
- 분석 기간: **2023.11.01 ~ 2024.10.31** (1년)

**예시 (실행일: 2024년 12월 20일)**
- 12월 20일 >= 15일 이므로 → 기준일 = **2024년 11월 30일**
- 분석 기간: **2023.12.01 ~ 2024.11.30** (1년)

### 2.3 대상 농가 필터링
```sql
-- 유효 농가 조건
SELECT FARM_NO
FROM TA_FARM
WHERE USE_YN = 'Y'
  AND TEST_YN = 'N';
```

---

## 3. 데이터 처리 로직

### 3.1 처리 흐름

```
┌─────────────────────────────────────────────────────────────┐
│                    ETL 처리 흐름                             │
├─────────────────────────────────────────────────────────────┤
│  1. 분석 기준일 계산                                         │
│        │                                                    │
│        ▼                                                    │
│  2. 유효 농가 목록 조회                                      │
│        │                                                    │
│        ▼                                                    │
│  3. 농가별 연간 성적 산출 ─────► FARM_ANNUAL_PERFORMANCE    │
│        │                                                    │
│        ├─► 벤치마킹 평균 산출 ──► farm_no=0 (가상농가)      │
│        │                                                    │
│        ▼                                                    │
│  4. 산차별 성적 산출 ──────────► FARM_PARITY_ANNUAL_PERF    │
│        │                                                    │
│        ▼                                                    │
│  5. 모돈별 성적 산출 ──────────► FARM_SOW_PERFORMANCE       │
│        │                                                    │
│        ▼                                                    │
│  6. 완료 (매일 덮어쓰기)                                     │
└─────────────────────────────────────────────────────────────┘
```

### 3.2 농가별 연간 성적 (Farm Annual Performance)

**산출 지표** (약 20여 가지):
| 지표 | 설명 |
|------|------|
| PSY | 모돈당 연간 이유두수 |
| MSY | 모돈당 연간 출하두수 |
| 분만율 | 교배 대비 분만 비율 |
| 모돈회전율 | 연간 분만 횟수 |
| NPD | 비생산일수 |
| LSY | 연간 산자손실률 |
| 평균 총산 | 분만당 총산자수 평균 |
| 평균 실산 | 분만당 실산자수 평균 |
| 평균 이유두수 | 이유당 자돈수 평균 |
| ... | 기타 지표 |

**벤치마킹 기준 산출 조건**:
```sql
-- 정상 데이터 범위 농가만 필터링
WHERE 상시모돈수 >= 20
  AND NPD <= 150
  AND PSY >= 14
  AND LSY <= 2.6
```
- 위 조건을 만족하는 농가들의 평균을 **가상 농가(farm_no=0)**로 저장
- 각 농가는 이 평균값과 비교하여 성적 수준 파악 가능

### 3.3 산차별 성적 (Parity Performance)

각 농가의 산차(1산~8산 이상)별로 다음 지표를 분석:
- 평균 총산자수
- 평균 재귀발정일

### 3.4 모돈별 성적 (Sow Performance)

농가 내 개별 모돈의 산차별 성적을 산출:
- 평균 총산자수
- 평균 재귀일

---

## 4. 대상 테이블

### 4.1 테이블 목록

| 테이블명 | 설명 | 처리방식 | 비고 |
|----------|------|----------|------|
| FARM_ANNUAL_PERFORMANCE | 농가별 연간 성적 | Merge (Upsert) | 농가별 1행 + farm_no=0 |
| FARM_PARITY_ANNUAL_PERFORMANCE | 산차별 연간 성적 | Merge (Upsert) | 농가-산차별 데이터 |
| FARM_SOW_PERFORMANCE | 모돈별 성적 | Delete & Insert | Batch 처리 |

### 4.2 데이터 갱신 주기

```
┌─────────────────────────────────────────────────────────────┐
│  매일 실행 → 데이터 덮어쓰기 (Merge/Upsert)                  │
│                                                             │
│  매월 16일 → 분석 대상 월 변경 (새로운 월 데이터 시작)       │
│                                                             │
│  결과: 해당 월의 성적 데이터가 조금씩 보정되면서 업데이트    │
└─────────────────────────────────────────────────────────────┘
```

---

## 5. 테이블 DDL

### 5.1 FARM_ANNUAL_PERFORMANCE (농가별 연간 성적)

> 별도 DDL 문서 참조 (현재 운영 중인 테이블)

### 5.2 FARM_PARITY_ANNUAL_PERFORMANCE (산차별 연간 성적)

```sql
CREATE TABLE FARM_PARITY_ANNUAL_PERFORMANCE (
    ID                             NUMBER DEFAULT FARM_PARITY_ANNUAL_PERFORMANCE_SEQ.NEXTVAL,
    FARM_NO                        NUMBER NOT NULL,           -- 농가번호
    PARITY                         NUMBER NOT NULL,           -- 산차
    ANALYSIS_YEAR                  NUMBER NOT NULL,           -- 분석년도
    ANALYSIS_MONTH                 NUMBER NOT NULL,           -- 분석월
    AVERAGE_TOTAL_BORN             NUMBER(10,2),              -- 평균총산
    AVERAGE_RETURN_TO_ESTRUS_DAYS  NUMBER(10,2),              -- 평균재귀발정일령
    PERFORMANCE_START_DATE         DATE,                      -- 성과 시작일
    PERFORMANCE_END_DATE           DATE,                      -- 성과 종료일
    LAST_UPDATED                   TIMESTAMP(6) DEFAULT SYSTIMESTAMP,  -- 최종 수정일시
    INCLUDED_IN_AVERAGE            NUMBER(1) DEFAULT 0,       -- 평균 산출 포함 여부

    CONSTRAINT PK_PARITY_PERF PRIMARY KEY (ID)
);

-- 유니크 인덱스 (복합키)
CREATE UNIQUE INDEX UK_PARITY_PERFORMANCE
    ON FARM_PARITY_ANNUAL_PERFORMANCE(FARM_NO, PARITY, ANALYSIS_YEAR, ANALYSIS_MONTH);

-- 조회용 인덱스
CREATE INDEX IDX_PARITY_FARM_YEAR_MONTH
    ON FARM_PARITY_ANNUAL_PERFORMANCE(FARM_NO, ANALYSIS_YEAR, ANALYSIS_MONTH);

-- 코멘트
COMMENT ON TABLE FARM_PARITY_ANNUAL_PERFORMANCE IS '농가 산차별 연간 성과';
COMMENT ON COLUMN FARM_PARITY_ANNUAL_PERFORMANCE.ID IS '고유번호';
COMMENT ON COLUMN FARM_PARITY_ANNUAL_PERFORMANCE.FARM_NO IS '농가번호';
COMMENT ON COLUMN FARM_PARITY_ANNUAL_PERFORMANCE.PARITY IS '산차';
COMMENT ON COLUMN FARM_PARITY_ANNUAL_PERFORMANCE.ANALYSIS_YEAR IS '분석년도';
COMMENT ON COLUMN FARM_PARITY_ANNUAL_PERFORMANCE.ANALYSIS_MONTH IS '분석월';
COMMENT ON COLUMN FARM_PARITY_ANNUAL_PERFORMANCE.AVERAGE_TOTAL_BORN IS '평균총산';
COMMENT ON COLUMN FARM_PARITY_ANNUAL_PERFORMANCE.AVERAGE_RETURN_TO_ESTRUS_DAYS IS '평균재귀발정일령';
COMMENT ON COLUMN FARM_PARITY_ANNUAL_PERFORMANCE.PERFORMANCE_START_DATE IS '성과 시작일';
COMMENT ON COLUMN FARM_PARITY_ANNUAL_PERFORMANCE.PERFORMANCE_END_DATE IS '성과 종료일';
COMMENT ON COLUMN FARM_PARITY_ANNUAL_PERFORMANCE.LAST_UPDATED IS '최종 수정일시';
```

### 5.3 FARM_SOW_PERFORMANCE (모돈별 성적)

```sql
CREATE TABLE FARM_SOW_PERFORMANCE (
    ID                      NUMBER GENERATED ALWAYS AS IDENTITY
                            (START WITH 1 INCREMENT BY 1 NOCACHE) NOT NULL,
    FARM_NO                 NUMBER NOT NULL,                -- 농장 번호
    PIG_NO                  NUMBER NOT NULL,                -- 모돈 번호
    PARITY                  NUMBER(2) NOT NULL,             -- 산차
    AVERAGE_TOTAL_BORN      NUMBER(5,1),                    -- 평균 총산자수
    AVERAGE_RETURN_DAYS     NUMBER(5,1),                    -- 평균 재귀일
    ANALYSIS_YEAR           NUMBER(4) NOT NULL,             -- 분석 연도
    ANALYSIS_MONTH          NUMBER(2) NOT NULL,             -- 분석 월
    PERFORMANCE_START_DATE  DATE,                           -- 성적 시작일
    PERFORMANCE_END_DATE    DATE,                           -- 성적 종료일
    LAST_UPDATED            TIMESTAMP(6) DEFAULT SYSTIMESTAMP,  -- 최종 수정일시

    CONSTRAINT PK_FARM_SOW_PERF PRIMARY KEY (ID)
);

-- 유니크 인덱스 (복합키)
CREATE UNIQUE INDEX UK_FARM_SOW_PERF
    ON FARM_SOW_PERFORMANCE(FARM_NO, PIG_NO, PARITY, ANALYSIS_YEAR, ANALYSIS_MONTH);

-- 조회용 인덱스
CREATE INDEX IDX_FARM_SOW_PERF_1
    ON FARM_SOW_PERFORMANCE(FARM_NO, ANALYSIS_YEAR, ANALYSIS_MONTH);

-- 코멘트
COMMENT ON TABLE FARM_SOW_PERFORMANCE IS '농장별 모돈별 산차별 연간 성적';
COMMENT ON COLUMN FARM_SOW_PERFORMANCE.ID IS '고유 식별자';
COMMENT ON COLUMN FARM_SOW_PERFORMANCE.FARM_NO IS '농장 번호';
COMMENT ON COLUMN FARM_SOW_PERFORMANCE.PIG_NO IS '모돈 번호';
COMMENT ON COLUMN FARM_SOW_PERFORMANCE.PARITY IS '산차';
COMMENT ON COLUMN FARM_SOW_PERFORMANCE.AVERAGE_TOTAL_BORN IS '평균 총산자수';
COMMENT ON COLUMN FARM_SOW_PERFORMANCE.AVERAGE_RETURN_DAYS IS '평균 재귀일';
COMMENT ON COLUMN FARM_SOW_PERFORMANCE.ANALYSIS_YEAR IS '분석 연도';
COMMENT ON COLUMN FARM_SOW_PERFORMANCE.ANALYSIS_MONTH IS '분석 월';
COMMENT ON COLUMN FARM_SOW_PERFORMANCE.PERFORMANCE_START_DATE IS '성적 시작일';
COMMENT ON COLUMN FARM_SOW_PERFORMANCE.PERFORMANCE_END_DATE IS '성적 종료일';
COMMENT ON COLUMN FARM_SOW_PERFORMANCE.LAST_UPDATED IS '최종 수정일시';
```

---

## 6. 조회 쿼리 예시

### 6.1 농가 연간 성적 조회

```sql
-- 특정 농가의 최신 연간 성적 조회
SELECT *
FROM FARM_ANNUAL_PERFORMANCE
WHERE FARM_NO = :farmNo
ORDER BY ANALYSIS_YEAR DESC, ANALYSIS_MONTH DESC
FETCH FIRST 1 ROW ONLY;

-- 벤치마킹 평균값 조회 (가상농가)
SELECT *
FROM FARM_ANNUAL_PERFORMANCE
WHERE FARM_NO = 0
AND ANALYSIS_YEAR = :year
AND ANALYSIS_MONTH = :month;

-- 농가 vs 평균 비교
SELECT
    f.FARM_NO,
    f.PSY AS FARM_PSY,
    b.PSY AS BENCHMARK_PSY,
    f.PSY - b.PSY AS PSY_DIFF
FROM FARM_ANNUAL_PERFORMANCE f
CROSS JOIN (
    SELECT PSY FROM FARM_ANNUAL_PERFORMANCE WHERE FARM_NO = 0
) b
WHERE f.FARM_NO = :farmNo;
```

### 6.2 산차별 성적 조회

```sql
-- 특정 농가의 산차별 성적 조회
SELECT
    PARITY,
    AVERAGE_TOTAL_BORN,
    AVERAGE_RETURN_TO_ESTRUS_DAYS
FROM FARM_PARITY_ANNUAL_PERFORMANCE
WHERE FARM_NO = :farmNo
AND ANALYSIS_YEAR = :year
AND ANALYSIS_MONTH = :month
ORDER BY PARITY;

-- 전체 평균 대비 농가 산차별 성적
SELECT
    f.PARITY,
    f.AVERAGE_TOTAL_BORN AS FARM_AVG,
    b.AVERAGE_TOTAL_BORN AS BENCHMARK_AVG
FROM FARM_PARITY_ANNUAL_PERFORMANCE f
LEFT JOIN FARM_PARITY_ANNUAL_PERFORMANCE b
    ON f.PARITY = b.PARITY
    AND b.FARM_NO = 0
    AND b.ANALYSIS_YEAR = f.ANALYSIS_YEAR
    AND b.ANALYSIS_MONTH = f.ANALYSIS_MONTH
WHERE f.FARM_NO = :farmNo
AND f.ANALYSIS_YEAR = :year
AND f.ANALYSIS_MONTH = :month
ORDER BY f.PARITY;
```

### 6.3 모돈별 성적 조회

```sql
-- 특정 농가의 모돈별 성적 조회
SELECT
    PIG_NO,
    PARITY,
    AVERAGE_TOTAL_BORN,
    AVERAGE_RETURN_DAYS
FROM FARM_SOW_PERFORMANCE
WHERE FARM_NO = :farmNo
AND ANALYSIS_YEAR = :year
AND ANALYSIS_MONTH = :month
ORDER BY PIG_NO, PARITY;

-- 특정 모돈의 산차별 성적 추이
SELECT
    PARITY,
    AVERAGE_TOTAL_BORN,
    AVERAGE_RETURN_DAYS
FROM FARM_SOW_PERFORMANCE
WHERE FARM_NO = :farmNo
AND PIG_NO = :pigNo
ORDER BY PARITY;
```

---

## 7. inspig 연계 방안

### 7.1 주간 리포트에서 ETL 데이터 활용

주간 리포트에서 **1년간 비교 데이터**가 필요한 경우 ETL 데이터를 참조:

```typescript
// 예: 분만 성적의 1년 평균 대비 증감 표시
const yearlyAvg = await query(`
    SELECT AVERAGE_TOTAL_BORN
    FROM FARM_ANNUAL_PERFORMANCE
    WHERE FARM_NO = :farmNo
    AND ANALYSIS_YEAR = :year
    AND ANALYSIS_MONTH = :month
`, { farmNo, year, month });

// 주간 리포트의 LAST_BM_CHG_TOTAL 컬럼에 활용
const weeklyAvg = 14.2;  // 금주 평균
const change = weeklyAvg - yearlyAvg.AVERAGE_TOTAL_BORN;  // 증감
```

### 7.2 TS_INS_FARM 테이블 연계

주간 리포트 생성 시 ETL 데이터를 참조하여 증감값 계산:

| TS_INS_FARM 컬럼 | ETL 데이터 활용 |
|------------------|-----------------|
| LAST_BM_CHG_TOTAL | 금주 총산 평균 - ETL 1년 평균 총산 |
| LAST_BM_CHG_LIVE | 금주 실산 평균 - ETL 1년 평균 실산 |
| LAST_EU_CHG_KG | 금주 이유체중 - ETL 1년 평균 이유체중 |

---

## 8. 참고사항

### 8.1 데이터 갱신 특성
- **매일 실행**: 데이터가 매일 갱신되어 최신화
- **월 단위 확정**: 매월 16일에 분석 대상 월이 변경
- **덮어쓰기 방식**: 동일 키(농가, 연도, 월)의 데이터는 갱신됨

### 8.2 주의사항
- ETL 실행 시간(02:00)과 주간 리포트 생성 시간(03:00)이 겹치지 않도록 설계됨
- 벤치마킹 평균(farm_no=0)은 필터 조건을 만족하는 농가만 포함
- 모돈별 성적(FARM_SOW_PERFORMANCE)은 Delete & Insert 방식으로 전체 재생성됨

### 8.3 데이터 규모 예상
- FARM_ANNUAL_PERFORMANCE: 농가수 + 1 (가상농가) ≈ 1,000건/월
- FARM_PARITY_ANNUAL_PERFORMANCE: 농가수 × 산차수(~10) ≈ 10,000건/월
- FARM_SOW_PERFORMANCE: 농가수 × 평균모돈수 × 산차수 ≈ 수백만 건
