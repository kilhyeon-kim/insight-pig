# INS 테이블 설계

> inspig 주간/월간/분기 리포트용 테이블 구조 및 관계

---

## 1. 테이블 구조

```
┌──────────────────────────┐     ┌─────────────────────────────────────┐
│    TS_INS_SERVICE        │     │          TS_INS_MASTER              │
│  - 서비스 신청 농장       │     │  - 주/월별 리포트 생성 기준 정보     │
│  - FK → TA_FARM          │     │  - 대상수, 완료수, 생성상태          │
└────────────┬─────────────┘     └──────────────────┬──────────────────┘
             │ 1:N                                   │ 1:N (DAY_GB별 분기)
             │         ┌─────────────────────────────┤
             │         │                             │
             ▼         ▼                             ▼
┌─────────────────────────────┐  ┌──────────────┐  ┌──────────────┐
│      TS_INS_WEEK (주간)      │  │ TS_INS_MON   │  │  TS_INS_QT   │
│  - PK: (MASTER_SEQ, FARM_NO) │  │   (월간)     │  │   (분기)     │
│  - FK: MASTER_SEQ            │  │   [추후]     │  │   [추후]     │
│  - FK: FARM_NO               │  └──────────────┘  └──────────────┘
└─────────────────────────┬───┘
                          │ 1:N
                          ▼
┌─────────────────────────────────────────────────────────────┐
│                  TS_INS_WEEK_SUB (상세)                       │
│  - 각 팝업별 리스트 데이터 (주간/월간/분기 공용)               │
│  - GUBUN으로 데이터 유형 구분                                 │
└─────────────────────────────────────────────────────────────┘
```

---

## 2. 테이블 분류

### INS 핵심 테이블 (02_TABLE.sql)

| 테이블명 | 설명 | 비고 |
|----------|------|------|
| TA_SYS_CONFIG | 시스템 설정 | 1 row, 전반 설정 |
| TS_INS_SERVICE | 서비스 신청 | FK → TA_FARM |
| TS_INS_MASTER | 리포트 마스터 | 주/월/분기 생성 기준 |
| TS_INS_JOB_LOG | 실행 로그 | 프로시저 상태/오류 |
| TS_INS_WEEK | 주간 리포트 | 농장별 요약 데이터 |
| TS_INS_WEEK_SUB | 상세 데이터 | 팝업별 리스트 |
| TS_INS_MGMT | 관리포인트 | 하이라이트, 추천 |
| TS_INS_ACCESS_LOG | 접속 로그 | 로그인/메뉴/보고서 |

### 공통/ETC 테이블 (03_TABLE_ETC.sql)

| 테이블명 | 설명 | 비고 |
|----------|------|------|
| TM_WEATHER | 날씨 | 기상청 API 데이터 |
| TS_PSY_DELAY_HEATMAP | PSY 히트맵 | 농장 분포 |

---

## 3. 주요 설계 사항

### TS_INS_MASTER - 중복 방지

- UK: `(DAY_GB, REPORT_YEAR, REPORT_WEEK_NO)`
- 동일 년도+주차/월/분기에 1회만 생성

### TS_INS_WEEK_SUB - GUBUN/SUB_GUBUN 코드

**키 구조**: `PK(MASTER_SEQ, FARM_NO, GUBUN, SUB_GUBUN, SORT_NO)`

| GUBUN | SUB_GUBUN | 설명 |
|-------|-----------|------|
| MODON | - | 모돈현황 산차별×상태별 |
| ALERT | - | 관리대상 기간별 |
| ALERT | LIST | 관리대상 모돈목록 |
| GB | STAT | 교배 요약 |
| GB | CHART | 재귀일별 차트 |
| BM | - | 분만 요약 |
| EU | - | 이유 요약 |
| SG | STAT | 임신사고 원인별 |
| SG | CHART | 임신일별 차트 |
| DOPE | STAT | 도태폐사 유형별 |
| DOPE | LIST | 원인별 목록 |
| DOPE | CHART | 상태별 차트 |
| SHIP | STAT | 출하 요약 |
| SHIP | ROW | 크로스탭 행 |
| SHIP | CHART | 분석 차트 |
| SHIP | SCATTER | 산점도 |
| SCHEDULE | - | 예정 요약 |
| SCHEDULE | CAL | 캘린더 행 |
| SCHEDULE | GB | 교배예정 목록 |
| SCHEDULE | BM | 분만예정 목록 |
| SCHEDULE | EU | 이유예정 목록 |
| SCHEDULE | VACCINE | 백신예정 목록 |

> 상세 규칙: [03.procedure-rules.md](./03.procedure-rules.md)

### TS_INS_ACCESS_LOG - 메뉴코드 규칙

8자리: `XX000000`
- 1-2자리: WY(주간), MY(월간), QY(분기), ST(설정)
- 3-4자리: 1차 메뉴 (01~99)
- 5-6자리: 2차 메뉴 (01~99)
- 7-8자리: 3차 메뉴 (01~99)

---

## 4. 데이터 보관 정책

| 유형 | 보관 기간 |
|------|----------|
| WEEK (주간) | 2년 |
| MON (월간) | 5년 |
| QT (분기) | 10년 |
| JOB_LOG | 6개월 |
| ACCESS_LOG | 1년 |

---

## 5. 이슈 사항

1. **오류 로깅 통합**: TS_INS_WEEK.ERROR_MSG 제거 → TS_INS_JOB_LOG에서 통합 관리
2. **실시간 진행현황**: TS_INS_MASTER.COMPLETE_CNT, ERROR_CNT는 농장 처리 완료 시 실시간 UPDATE
3. **Oracle 19c**: COMMENT ON SEQUENCE 미지원 → 인라인 주석 사용

---

## SQL 참조

- [02_TABLE.sql](../sql/ins/02_TABLE.sql) - INS 테이블 DDL
- [03_TABLE_ETC.sql](../sql/ins/03_TABLE_ETC.sql) - 공통/ETC 테이블 DDL
