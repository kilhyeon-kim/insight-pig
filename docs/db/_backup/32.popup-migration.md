# 주간 리포트 DB 전환 체크리스트

**대상**: Backend 개발자, LLM
**최종 업데이트**: 2025-12-12

---

## 1. 페이지 데이터 (TS_INS_WEEK)

페이지에 표시되는 요약 데이터는 TS_INS_WEEK 테이블에서 조회.

### 현재 상태
- ✅ **헤더 정보**: farmNo, farmNm, ownerNm, year, weekNo, period
- ✅ **관리대상모돈 요약**: alertMd.count, euMiCnt, sgMiCnt, bmDelayCnt, euDelayCnt
- ✅ **모돈 현황**: modon.regCnt, sangsiCnt
- ✅ **교배 실적**: mating.cnt, sum
- ✅ **분만 실적**: farrowing.cnt, totalCnt, liveCnt, avgTotal, avgLive, changeTotal, changeLive 등
- ✅ **이유 실적**: weaning.cnt, jdCnt, avgWeight, changeWeight 등
- ✅ **임신사고**: accident.cnt, sum
- ✅ **도태폐사**: culling.cnt, sum
- ✅ **출하 실적**: shipment.cnt, avg, sum, avgSum
- ✅ **금주 예정**: thisWeek.gbSum, bmSum, euSum 등
- ✅ **KPI**: kpi.psy, delayDay, psyX, psyY, psyZone

### 필드명 매핑 (백엔드 → 프론트엔드)
| 테이블 컬럼 | 백엔드 응답 | 프론트엔드 타입 |
|-------------|-------------|-----------------|
| LAST_BM_TOTAL | totalCnt | totalCnt ✅ |
| LAST_BM_LIVE | liveCnt | liveCnt ✅ |
| LAST_BM_CHG_TOTAL | changeTotal | changeTotal ✅ |
| LAST_EU_AVG_KG | avgWeight | avgWeight ✅ |
| LAST_EU_CHG_KG | changeWeight | changeWeight ✅ |
| LAST_SH_AVG_KG | avg | avg ✅ |

---

## 2. 팝업 데이터 (TS_INS_WEEK_SUB)

주간 리포트 상세 페이지의 팝업 데이터를 Mock에서 실제 DB로 점진적 전환.

### 현재 상태
- ✅ **관리대상모돈 (alertMd)**: DB 전환 완료 (GUBUN: ALERT_MD)
- ✅ **모돈현황 (modon)**: DB 전환 완료 (GUBUN: MODON)
- ✅ **교배실적 (mating)**: DB 전환 완료 (GUBUN: MATING_T, MATING_C)
- ✅ **분만실적 (farrowing)**: DB 전환 완료 (GUBUN: FARROWING)
- ✅ **이유실적 (weaning)**: DB 전환 완료 (GUBUN: WEANING)
- ✅ **임신사고 (accident)**: DB 전환 완료 (GUBUN: ACCIDENT_T, ACCIDENT_C)
- ✅ **도태폐사 (culling)**: DB 전환 완료 (GUBUN: CULLING_S, CULLING_T)
- ✅ **출하실적 (shipment)**: DB 전환 완료 (GUBUN: SHIP_M, SHIP_G, SHIP_D, SHIP_C)

---

## 전환 순서

### 1. 모돈현황 (modon) ✅ 완료
- **GUBUN**: `MODON` (산차별 × 상태별 교차표)
- **DB 컬럼 매핑**: CODE1=산차, CNT1~5=후보/임신/포유/이유모/사고, CNT6=증감
- **프론트엔드 타입**: `ModonPopupData`
  ```typescript
  {
    table: ModonTableRow[];  // parity, hubo, imsin, poyu, eumo, sago, change, group
    chart: { xAxis: string[]; data: number[]; }
  }
  ```
- **원본 SQL 구조**: 상태별(행) × 산차별(열)
- **변환 필요**: 산차별(행) × 상태별(열)로 피벗
- **TS_INS_WEEK_SUB 저장 구조**:
  | CODE1 | CNT1(후보) | CNT2(임신) | CNT3(포유) | CNT4(이유모) | CNT5(사고) | CNT6(증감) |
  |-------|----------|----------|----------|------------|----------|----------|
  | 후보돈 | 0 | 0 | 0 | 0 | 0 | 0 |
  | 0산   | 5 | 10 | 3 | 2 | 1 | +2 |
  | 1산   | 0 | 15 | 5 | 3 | 0 | -1 |
  | ...   | ... | ... | ... | ... | ... | ... |
  | 8산↑  | 0 | 8 | 2 | 4 | 2 | 0 |
- **데이터 INSERT SQL (피벗 변환)**:
  ```sql
  -- 원본 SQL의 x,y축을 바꿔서 산차별(행)로 저장
  INSERT INTO TS_INS_WEEK_SUB (MASTER_SEQ, FARM_NO, GUBUN, SORT_NO, CODE1, CNT1, CNT2, CNT3, CNT4, CNT5, CNT6)
  SELECT :masterSeq, :farmNo, 'MODON', ROWNUM, PARITY,
         NVL(SUM(CASE WHEN STATUS_CODE = '010001' THEN CNT END), 0) AS HUBO,    -- 후보
         NVL(SUM(CASE WHEN STATUS_CODE = '010002' THEN CNT END), 0) AS IMSIN,   -- 임신
         NVL(SUM(CASE WHEN STATUS_CODE = '010003' THEN CNT END), 0) AS POYU,    -- 포유(010003+010004)
         NVL(SUM(CASE WHEN STATUS_CODE = '010005' THEN CNT END), 0) AS EUMO,    -- 이유모
         NVL(SUM(CASE WHEN STATUS_CODE = '010007' THEN CNT END), 0) AS SAGO,    -- 사고(010006+010007)
         0 AS CHANGE  -- 증감 (별도 계산 필요)
  FROM (
      SELECT CASE WHEN SANCHA = 0 AND STATUS_CODE = '010001' THEN '후보돈'
                  WHEN SANCHA = 0 THEN '0산'
                  WHEN SANCHA = 1 THEN '1산'
                  WHEN SANCHA = 2 THEN '2산'
                  WHEN SANCHA = 3 THEN '3산'
                  WHEN SANCHA = 4 THEN '4산'
                  WHEN SANCHA = 5 THEN '5산'
                  WHEN SANCHA = 6 THEN '6산'
                  WHEN SANCHA = 7 THEN '7산'
                  WHEN SANCHA >= 8 THEN '8산↑'
             END AS PARITY,
             CASE WHEN STATUS_CODE IN ('010004') THEN '010003'
                  WHEN STATUS_CODE IN ('010006') THEN '010007'
                  ELSE STATUS_CODE
             END AS STATUS_CODE,
             1 AS CNT
      FROM VW_MODON_DATE_2020_MAX_WK
      WHERE FARM_NO = :farmNo
        AND IN_DT <= TO_DATE(:toDate, 'yyyy-MM-dd')
        AND OUT_DT > TO_DATE(:toDate, 'yyyy-MM-dd')
  )
  GROUP BY PARITY
  ORDER BY DECODE(PARITY, '후보돈', 0, '0산', 1, '1산', 2, '2산', 3, '3산', 4,
                          '4산', 5, '5산', 6, '6산', 7, '7산', 8, '8산↑', 9);
  ```
- **작업 내용**:
  - [x] SUB 테이블 GUBUN 확인 및 데이터 구조 분석
  - [x] `transformParityDistPopup` 리팩토링
  - [x] table 데이터 구성 (산차별 × 상태별 교차표)
  - [x] chart 데이터 구성 (산차별 두수)
  - [ ] 프론트엔드 테스트

### 2. 교배실적 (mating) ✅ 완료
- **GUBUN**: `MATING_T` (유형별), `MATING_C` (재귀일별 차트)
- **DB 컬럼 매핑**:
  - MATING_T: CODE1=유형코드, CNT1=계획, CNT2=실적
  - MATING_C: CODE1=재귀일, CNT1=두수
- **프론트엔드 타입**: `MatingPopupData`
- **작업 내용**:
  - [x] `transformMatingPopup` 리팩토링
  - [x] table 데이터 구성 (유형별)
  - [x] total 합계 계산
  - [x] chart 데이터 구성 (재귀일별)
  - [ ] 프론트엔드 테스트

### 3. 분만실적 (farrowing) ✅ 완료
- **GUBUN**: `FARROWING`
- **DB 컬럼 매핑**: CODE1=항목코드(PLANNED/ACTUAL/TOTAL_BORN/BORN_ALIVE/...), CNT1=합계, VAL1=평균, VAL2=비율
- **프론트엔드 타입**: `FarrowingPopupData`
- **작업 내용**:
  - [x] `transformFarrowingPopup` 리팩토링
  - [x] 통계 계산 로직 구현
  - [ ] 프론트엔드 테스트

### 4. 이유실적 (weaning) ✅ 완료
- **GUBUN**: `WEANING`
- **DB 컬럼 매핑**: CODE1=항목코드(PLANNED/ACTUAL/WEAN_PIGS/...), CNT1=합계, VAL1=평균
- **프론트엔드 타입**: `WeaningPopupData`
- **작업 내용**:
  - [x] `transformWeaningPopup` 리팩토링
  - [x] 통계 계산 로직 구현
  - [ ] 프론트엔드 테스트

### 5. 임신사고 (accident) ✅ 완료
- **GUBUN**: `ACCIDENT_T` (원인별), `ACCIDENT_C` (임신일별 차트)
- **DB 컬럼 매핑**:
  - ACCIDENT_T: CODE1=원인코드, CNT1=금주, CNT2=누계
  - ACCIDENT_C: CODE1=임신일구간, CNT1=두수
- **프론트엔드 타입**: `AccidentPopupData`
- **작업 내용**:
  - [x] `transformAccidentPopup` 리팩토링
  - [x] table/chart 데이터 구성
  - [ ] 프론트엔드 테스트

### 6. 도태폐사 (culling) ✅ 완료
- **GUBUN**: `CULLING_S` (유형요약), `CULLING_T` (원인별)
- **DB 컬럼 매핑**:
  - CULLING_S: CNT1=도태, CNT2=폐사, CNT3=전출, CNT4=매각
  - CULLING_T: CODE1=원인코드, CNT1=금주, CNT2=누계
- **프론트엔드 타입**: `CullingPopupData`
- **작업 내용**:
  - [x] `transformCullingPopup` 리팩토링
  - [x] stats/table 데이터 구성
  - [ ] 프론트엔드 테스트

### 7. 출하실적 (shipment) ✅ 완료
- **GUBUN**: `SHIP_M` (현황요약), `SHIP_G` (등급분포), `SHIP_D` (일별상세), `SHIP_C` (도체분포차트)
- **DB 컬럼 매핑**:
  - SHIP_M: CNT1=총두수, STR1=전주대비, VAL1=1+율, VAL2=평균도체중, VAL3=평균등지방
  - SHIP_G: CODE1=등급코드, CNT1=두수, VAL1=비율
  - SHIP_D: STR1=일자, CNT1=두수, VAL1=평균도체중, VAL2=평균등지방, VAL3=1+율
  - SHIP_C: VAL1=도체중, VAL2=등지방
- **프론트엔드 타입**: `ShipmentPopupData`
- **작업 내용**:
  - [x] `transformShipmentPopup` 리팩토링
  - [x] metrics/gradeDistribution/dailyTable/analysisChart/carcassChart 구성
  - [ ] 프론트엔드 테스트

---

## 공통 작업 패턴

### 1. SUB 테이블 데이터 확인
```sql
SELECT GUBUN, CODE1, CODE2, CNT1, CNT2, CNT3, CNT4, CNT5, CNT6,
       VAL1, VAL2, VAL3, VAL4, STR1, STR2
FROM TS_INS_WEEK_SUB
WHERE MASTER_SEQ = :masterSeq AND FARM_NO = :farmNo
  AND GUBUN LIKE 'MODON%'  -- 팝업별 GUBUN 패턴
ORDER BY SORT_NO;
```

### 2. Transform 함수 수정
```typescript
// 기존: 단순 배열 반환
private transformXxxPopup(subs: TsInsWeekSub[]) {
  return subs.map(s => ({ ... }));
}

// 변경: 프론트엔드 타입에 맞는 구조 반환
private transformXxxPopup(subs: TsInsWeekSub[]): XxxPopupData {
  return {
    table: subs.filter(s => s.code2 === 'TABLE').map(...),
    chart: {
      xAxis: subs.filter(s => s.code2 === 'CHART').map(s => s.code1),
      data: subs.filter(s => s.code2 === 'CHART').map(s => s.cnt1),
    }
  };
}
```

### 3. GUBUN 매핑 (실제 코드)
```typescript
// weekly.service.ts getPopupData()
const gubunMap: Record<string, string> = {
  alertMd: 'ALERT_MD',
  modon: 'MODON',           // 모돈현황: MODON (산차별 × 상태별)
  mating: 'MATING_%',       // 교배실적: MATING_T(유형별), MATING_C(재귀일차트)
  farrowing: 'FARROWING',   // 분만실적
  weaning: 'WEANING',       // 이유실적
  accident: 'ACCIDENT_%',   // 임신사고: ACCIDENT_T(원인별), ACCIDENT_C(임신일차트)
  culling: 'CULLING_%',     // 도태폐사: CULLING_S(요약), CULLING_T(원인별)
  shipment: 'SHIP_%',       // 출하실적: SHIP_M(요약), SHIP_G(등급), SHIP_D(일별), SHIP_C(차트)
  schedule: 'SCHEDULE_%',
};
```

---

## 참고 파일

- **백엔드 서비스**: `api/src/modules/weekly/weekly.service.ts`
- **SQL 쿼리**: `api/src/modules/weekly/sql/weekly.sql.ts`
- **프론트엔드 타입**: `web/src/types/weekly.ts`
- **프론트엔드 팝업**: `web/src/app/(report)/weekly/_components/popups/`
- **Mock 데이터**: `api/src/data/mock/weekly.mock.ts`

---

## Oracle SQL 파일

### 기초 객체

| 순서 | 파일명 | 객체명 | 설명 |
|------|--------|--------|------|
| 01 | `01_SEQUENCE.sql` | SEQ_TS_INS_* | 시퀀스 정의 |
| 02 | `02_TABLE.sql` | TS_INS_* | 테이블 정의 |
| 03 | `03_VIEW.sql` | VW_MODON_DATE_2020_MAX_WK | 모돈 현황 뷰 (기준일 기준 마지막 작업) |
| 04 | `04_FUNCTION.sql` | SF_GET_MODONGB_STATUS | 모돈 상태코드/상태명 반환 함수 |
| 11 | `11_SP_INS_COM_LOG.sql` | SP_INS_COM_LOG_* | 공통 로그 프로시저 |

### 프로시저

| 순서 | 파일명 | 프로시저명 | 설명 |
|------|--------|------------|------|
| 21 | `21_SP_INS_WEEK_MAIN.sql` | SP_INS_WEEK_MAIN | 메인 프로시저 (스케줄 JOB에서 호출) |
| 22 | `22_SP_INS_WEEK_MANAGE_SOW.sql` | SP_INS_WEEK_MANAGE_SOW | 관리대상모돈 추출 (GUBUN='ALERT') |
| 23 | `23_SP_INS_WEEK_MODON_POPUP.sql` | SP_INS_WEEK_MODON_POPUP | 모돈현황 팝업 (GUBUN='MODON') |
| 31 | `31_JOB_INS_WEEKLY.sql` | JOB_INS_WEEKLY_REPORT | 스케줄러 JOB (매주 월요일 02:00 KST) |

### 실행 순서

```
JOB_INS_WEEKLY_REPORT (매주 월요일 02:00)
  └─ SP_INS_WEEK_MAIN
       └─ SP_INS_WEEK_FARM_PROCESS (농장별 병렬 처리)
            ├─ SP_INS_WEEK_MANAGE_SOW  (GUBUN='ALERT')
            ├─ SP_INS_WEEK_MODON_POPUP (GUBUN='MODON')
            │    └─ VW_MODON_DATE_2020_MAX_WK (기준일 기준 모돈 현황)
            │         └─ SF_GET_MODONGB_STATUS (상태코드 결정)
            └─ ... (추가 프로시저)
```

### 의존성

```
VW_MODON_DATE_2020_MAX_WK
  ├─ TB_MODON (모돈 마스터)
  ├─ TB_MODON_WK (모돈 작업이력)
  └─ SF_GET_MODONGB_STATUS (상태코드 함수)

SP_INS_WEEK_MODON_POPUP
  ├─ VW_MODON_DATE_2020_MAX_WK
  ├─ TS_INS_WEEK_SUB (결과 저장)
  └─ DBMS_SESSION.SET_IDENTIFIER (기준일 설정)
```
