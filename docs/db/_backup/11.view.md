# 뷰 정의서

> inspig 주간/월간 리포트 관련 뷰 정의

---

## 1. 모돈 최종작업 뷰 (VM_LAST_MODON_SEQ_WK)

각 모돈의 최종 작업 정보를 조회하는 뷰입니다. 리포트에서 모돈 현황 파악 시 유용합니다.

### 1.1 뷰 컬럼 설명

| 컬럼명 | 설명 | 비고 |
|--------|------|------|
| `FARM_NO` | 농장번호 | |
| `PIG_NO` | 시스템번호 | |
| `WK_DT` | 최종작업일자 | CHAR(8), 'YYYYMMDD' |
| `WK_DATE` | 최종작업일 | DATE |
| `SANCHA` | 산차 | |
| `GYOBAE_CNT` | 교배차수 | |
| `WK_GUBUN` | 최종작업구분 | G/B/E/F |
| `DAERI_YN` | 대리모여부 | |
| `SAGO_GUBUN_CD` | 사고구분코드 | |
| `LOC_CD` | 돈방코드 | |
| `G_CNT` | 총 교배횟수 | |
| `B_CNT` | 총 분만횟수 | |
| `E_CNT` | 총 이유횟수 | |
| `F_CNT` | 총 사고횟수 | |
| `SEQ` | 최종 시퀀스 | |
| `AUTO_GB` | 자동생성구분 | A:전입, Z:도폐사 |

### 1.2 활용 쿼리

```sql
-- 농장의 모돈 현황 (최종 작업 기준)
SELECT
    WK_GUBUN,
    COUNT(*) AS CNT
FROM VM_LAST_MODON_SEQ_WK v
JOIN TB_MODON m ON v.FARM_NO = m.FARM_NO AND v.PIG_NO = m.PIG_NO
WHERE v.FARM_NO = :farmNo
AND m.USE_YN = 'Y'
AND m.OUT_DT > SYSDATE  -- 활성 모돈만
GROUP BY WK_GUBUN;

-- 관리대상 모돈 조회 (교배 후 일정 기간 경과)
SELECT
    m.FARM_PIG_NO,
    v.WK_GUBUN,
    v.WK_DATE,
    TRUNC(SYSDATE) - v.WK_DATE AS DAYS_SINCE_LAST_WK,
    v.SANCHA
FROM VM_LAST_MODON_SEQ_WK v
JOIN TB_MODON m ON v.FARM_NO = m.FARM_NO AND v.PIG_NO = m.PIG_NO
WHERE v.FARM_NO = :farmNo
AND m.USE_YN = 'Y'
AND m.OUT_DT > SYSDATE
AND v.WK_GUBUN = 'G'  -- 최종작업이 교배
AND TRUNC(SYSDATE) - v.WK_DATE > 21  -- 교배 후 21일 이상 경과
ORDER BY v.WK_DATE;

-- 상태별 모돈 현황 집계 (리포트용)
SELECT
    CASE v.WK_GUBUN
        WHEN 'G' THEN '교배'
        WHEN 'B' THEN '포유'
        WHEN 'E' THEN '대기'
        WHEN 'F' THEN '사고후대기'
        ELSE '기타'
    END AS STATUS_NM,
    COUNT(*) AS CNT
FROM VM_LAST_MODON_SEQ_WK v
JOIN TB_MODON m ON v.FARM_NO = m.FARM_NO AND v.PIG_NO = m.PIG_NO
WHERE v.FARM_NO = :farmNo
AND m.USE_YN = 'Y'
AND m.OUT_DT > SYSDATE
GROUP BY v.WK_GUBUN;
```

---

## 2. 관련 뷰 비교

> **주의**: `VM_LAST_MODON_SEQ_WK` 뷰와 `VM_LAST_MODON_GUBUN_SEQ_WK` 뷰는 성격이 다릅니다.

| 뷰 | 설명 | 용도 |
|----|------|------|
| `VM_LAST_MODON_SEQ_WK` | 최종 작업 정보 (모든 작업 중 마지막) | 모돈 현재 상태 조회 |
| `VM_LAST_MODON_GUBUN_SEQ_WK` | 작업구분별 최종 정보 | 특정 작업의 최종 이력 조회 |

---

## 3. 주간 리포트용 활용 예시

### 3.1 관리대상 모돈 집계 (alertMd)

```sql
-- 관리대상 모돈: 이유 후 미교배
SELECT
    CASE
        WHEN TRUNC(SYSDATE) - v.WK_DATE <= 3 THEN '~3'
        WHEN TRUNC(SYSDATE) - v.WK_DATE <= 7 THEN '4~7'
        WHEN TRUNC(SYSDATE) - v.WK_DATE <= 14 THEN '8~14'
        ELSE '14~'
    END AS PERIOD_CD,
    COUNT(*) AS EU_MI_CNT
FROM VM_LAST_MODON_SEQ_WK v
JOIN TB_MODON m ON v.FARM_NO = m.FARM_NO AND v.PIG_NO = m.PIG_NO
WHERE v.FARM_NO = :farmNo
AND m.USE_YN = 'Y'
AND m.OUT_DT > SYSDATE
AND v.WK_GUBUN = 'E'  -- 최종작업이 이유
AND TRUNC(SYSDATE) - v.WK_DATE > 7  -- 이유 후 7일 이상 경과 (미교배)
GROUP BY
    CASE
        WHEN TRUNC(SYSDATE) - v.WK_DATE <= 3 THEN '~3'
        WHEN TRUNC(SYSDATE) - v.WK_DATE <= 7 THEN '4~7'
        WHEN TRUNC(SYSDATE) - v.WK_DATE <= 14 THEN '8~14'
        ELSE '14~'
    END;
```

### 3.2 산차별 모돈 현황 (modon)

```sql
-- 산차별 모돈 현황
SELECT
    CASE
        WHEN m.SANCHA = 0 THEN '후보돈'
        WHEN m.SANCHA >= 9 THEN '9산↑'
        ELSE m.SANCHA || '산'
    END AS PARITY_CD,
    CASE
        WHEN m.SANCHA = 0 THEN 'hubo'
        ELSE 'current'
    END AS GROUP_CD,
    SUM(CASE WHEN v.WK_GUBUN = 'G' THEN 1 ELSE 0 END) AS IMSIN_CNT,  -- 임신
    SUM(CASE WHEN v.WK_GUBUN = 'B' THEN 1 ELSE 0 END) AS POYU_CNT,   -- 포유
    SUM(CASE WHEN v.WK_GUBUN = 'E' THEN 1 ELSE 0 END) AS EUMO_CNT,   -- 대기
    SUM(CASE WHEN v.WK_GUBUN = 'F' THEN 1 ELSE 0 END) AS SAGO_CNT,   -- 사고
    COUNT(*) AS TOTAL_CNT
FROM VM_LAST_MODON_SEQ_WK v
JOIN TB_MODON m ON v.FARM_NO = m.FARM_NO AND v.PIG_NO = m.PIG_NO
WHERE v.FARM_NO = :farmNo
AND m.USE_YN = 'Y'
AND m.OUT_DT > SYSDATE
GROUP BY
    CASE
        WHEN m.SANCHA = 0 THEN '후보돈'
        WHEN m.SANCHA >= 9 THEN '9산↑'
        ELSE m.SANCHA || '산'
    END,
    CASE
        WHEN m.SANCHA = 0 THEN 'hubo'
        ELSE 'current'
    END
ORDER BY
    CASE
        WHEN m.SANCHA = 0 THEN 0
        WHEN m.SANCHA >= 9 THEN 10
        ELSE m.SANCHA
    END;
```
